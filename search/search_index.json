{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"SCrOFit","text":"<p>Welcome to the official documentation of SCrOFit!</p>"},{"location":"#overview","title":"Overview","text":""},{"location":"#getting-started","title":"Getting Started","text":"<p>Want to start using it immediately? Check out the Installation Guide.</p>"},{"location":"#tutorial-guide","title":"Tutorial Guide","text":"<p>The followings are tutorials of how to use SCrOFit in different scenarios:</p> <ul> <li>Run SMA data with SCrOFit</li> <li>Analyze SMA data after SCrOFit</li> </ul>"},{"location":"#citation","title":"Citation","text":"<p>If you use SCrOFit in your research, please cite the following paper:</p> <p>APA format:</p> <pre><code>To be continued.\n</code></pre> <p>BibTeX format:</p> <pre><code>To be continued.\n</code></pre>"},{"location":"installation/","title":"Installation Guide","text":"<p>This guide explains how to install and configure SCrOFit.</p>"},{"location":"installation/#prerequisites","title":"Prerequisites","text":"<p>Before installation, please ensure you have the following dependencies:</p> <ul> <li>Python &gt;= 3.12</li> <li>Other dependencies (if applicable)</li> </ul>"},{"location":"installation/#installation","title":"Installation","text":"<p>From GitHub (recommended for the latest version)</p> <pre><code>pip install git+https://github.com/compbioclub/SCrOFit.git\n</code></pre>"},{"location":"reference/","title":"Reference","text":"<ol> <li>Vicari, M., Mirzazadeh, R., Nilsson, A. et al. Spatial multimodal analysis of transcriptomes and metabolomes in tissues. Nat Biotechnol 42, 1046\u20131050 (2024)</li> </ol>"},{"location":"tutorial/analysis_SMA_after_SCrOFit%20copy/","title":"analysis SMA after SCrOFit copy","text":"<pre><code>import anndata as ad\nimport scanpy as sc\n\nin_dir = '../../../data/SMA_data'\nsample = 'V11T17-102'\nst_adata = ad.read_h5ad(f'{in_dir}/{sample}_st_pp.adata')\nsm_adata = ad.read_h5ad(f'{in_dir}/{sample}_sm_pp.adata')\nmdata = ad.read_h5ad(f'{in_dir}/{sample}_m_pp.adata')\n\n\nsm_adata.obsm['SCrOFit CCS'] = sm_adata.obsm['spatial_MCMF_map']\nsm_adata.obsm['SMA SM OCS'] = sm_adata.obsm['spatial']\nst_adata.obsm['SMA ST OCS'] = st_adata.obsm['spatial']\nsc.pl.spatial(st_adata, basis='SMA\\nST OCS')\nimport squidpy as sq\n\nmymap = {'unk': np.nan, 'unk2': np.nan}\nst_adata.obs['Region'] = st_adata.obs['RegionLoupe'].apply(lambda x: mymap.get(x, x))\nsq.pl.spatial_scatter(st_adata, color=['Region'], img=True, shape=None, library_id=sample,\n                      spatial_key='SMA\\nST OCS', size=0.5)\nsq.pl.spatial_scatter(st_adata, color=['dopamine'], img=True, shape=None, library_id=sample,\n                      spatial_key='SMA\\nST OCS', size=0.5, cmap='Set2')\n</code></pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_29340/502781488.py:4: FutureWarning: Use `squidpy.pl.spatial_scatter` instead.\n  sc.pl.spatial(st_adata, basis='SMA\\nST OCS')\n</code>\n</pre> <pre>\n<code>/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n</code>\n</pre> <pre><code>for color in st_adata.obs.columns:\n    if not color.startswith('MSN'):\n        continue\n    sq.pl.spatial_scatter(st_adata, color=color, img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='OrRd', \n                      size=0.5)\n</code></pre> <pre><code>for gene in ['SCG2', 'CHN1', 'NNAT', 'GFAP', 'MBP', 'TF', 'PLP1']:\n    sq.pl.spatial_scatter(st_adata, color=gene, img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=0.5)\n</code></pre> <pre><code>sq.pl.spatial_scatter(sm_adata, color='mz_674.2805', img=False, shape=None, library_id=sample,\n                      spatial_key='SMA\\nSM OCS', cmap='viridis', size=0.5)\nsq.pl.spatial_scatter(sm_adata, color='mz_674.2805', img=False, shape=None, library_id=sample,\n                      spatial_key='After SCrOFit\\nST OCS', cmap='plasma', size=0.5)\n</code></pre> <pre><code>#del st_adata.uns['Cell Type_colors']\ncell_types = [\"Astro_0\",\"Oligo_1\",\"MSN.D2.PenkPos_2\",\"MSN.D1.TacNeg_3\",\"Oligo_4\",\"MSN.D2.PenkNeg_5\",\n \"MSN.D1.TacPosB_6\",\"OPC_7\",\"Mi.MiR.Ma_8\",\"MSN.D1.TacPosA_9\",\"Astro_10\",\"Astro_11\",\"Inhib_MSN_12\",\n\"Inhib_13\",\"unk_14\",\"unk_15\",\"unk_16\",\"Astro_17\",\"MSN.D2_C_18\",\"unk_19\",\"OPC_20\",\"Oligo_21\",\"unk_22\"]\nX = st_adata.obs[cell_types].to_numpy()\nst_adata.obs['Cell Type'] = np.array(cell_types)[X.argmax(axis=1)]\nst_adata.obs['Cell Type'] = st_adata.obs['Cell Type'].apply(lambda x: '_'.join(x.split('_')[:-1]))\nst_adata.obs['Cell Type'] = st_adata.obs['Cell Type'].apply(lambda x: np.nan if x == 'unk' else x)\nsq.pl.spatial_scatter(st_adata, color=['Cell Type'], img=True, shape=None, library_id=sample,\n                      spatial_key='SMA\\nST OCS', size=0.5, cmap='Spectral')\n</code></pre> <pre>\n<code>/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n</code>\n</pre> <pre><code>%autoreload\nimport matplotlib.pyplot as plt\n\ndopamine = 'Dopamine (mz_674.2805)'\nmymap = {'unk': np.nan, 'unk2': np.nan}\nsm_adata.obs['Region'] = sm_adata.obs['ST_RegionLoupe'].apply(lambda x: mymap.get(x, x))\nmymap = st_adata.obs['Cell Type'].to_dict()\nsm_adata.obs['Cell Type'] = sm_adata.obs['ST_ST_id'].apply(lambda x: mymap[x])\n\nsm_adata.obs[dopamine] = dict(zip(sm_adata.obs.index, sm_adata[:, 'mz_674.2805'].X.reshape(-1)))\n\nimport seaborn as sns\nfig = plt.figure(figsize=(2,5)) \nsns.violinplot(sm_adata.obs.sort_values(by=\"Cell Type\") , y=\"Cell Type\", \n               x=dopamine, hue=\"Cell Type\",\n               palette=sc.pl.palettes.default_20,\n               legend=False)\nplt.show()\nfig = plt.figure(figsize=(2,5)) \nsns.violinplot(sm_adata.obs.sort_values(by=\"Region\") , y=\"Region\", \n               x=dopamine, hue=\"Region\",\n               palette=sc.pl.palettes.default_20,\n               legend=False)\nplt.show()\n</code></pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/388567632.py:14: UserWarning: The palette list has more values (20) than needed (12), which may not be intended.\n  sns.violinplot(sm_adata.obs.sort_values(by=\"Cell Type\") , y=\"Cell Type\",\n</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/388567632.py:20: UserWarning: The palette list has more values (20) than needed (3), which may not be intended.\n  sns.violinplot(sm_adata.obs.sort_values(by=\"Region\") , y=\"Region\",\n</code>\n</pre> <pre><code>SMA_cor_df['Region'] = 'Cd'\nSMA_cor_df['Method'] = 'SMA'\nSMA_cor_df\n</code></pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_29340/1681965334.py:1: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  SMA_cor_df['Region'] = 'Cd'\n/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_29340/1681965334.py:2: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  SMA_cor_df['Method'] = 'SMA'\n</code>\n</pre> dopamine gene rho Pvalue FDR sig corlabel InvLog10FDR Region Method 348 Dopamine NCDN 0.244814 8.910519e-101 1.517065e-97 PosCor NCDN 96.818996 Cd SMA 395 Dopamine HPCAL4 0.210742 1.407301e-74 1.198004e-71 PosCor HPCAL4 70.921542 Cd SMA 1550 Dopamine VSNL1 0.236569 4.872488e-94 6.787375e-91 PosCor VSNL1 90.168298 Cd SMA 2148 Dopamine CHN1 0.263871 2.375161e-117 1.819730e-113 PosCor CHN1 112.739993 Cd SMA 2290 Dopamine MAP2 0.200022 3.214671e-67 2.239018e-64 PosCor MAP2 63.649942 Cd SMA 2368 Dopamine SCG2 0.326443 4.317302e-182 6.615401e-178 PosCor SCG2 177.179444 Cd SMA 2845 Dopamine SYNPR 0.255258 1.098729e-109 3.367164e-106 PosCor SYNPR 105.472736 Cd SMA 3064 Dopamine TF -0.234649 1.659563e-92 2.119124e-89 NegCor TF 88.673844 Cd SMA 5685 Dopamine PEG10 0.229432 2.058726e-88 2.253275e-85 PosCor PEG10 84.647186 Cd SMA 6483 Dopamine LY6H 0.229322 2.504924e-88 2.558863e-85 PosCor LY6H 84.591953 Cd SMA 6715 Dopamine GDA 0.204074 5.952055e-70 4.343016e-67 PosCor GDA 66.362209 Cd SMA 8509 Dopamine THY1 0.250591 1.185839e-105 3.028434e-102 PosCor THY1 101.518782 Cd SMA 9885 Dopamine RTN1 0.205265 9.126335e-71 6.992142e-68 PosCor RTN1 67.155390 Cd SMA 10849 Dopamine CRYM 0.247718 3.268268e-103 7.154239e-100 PosCor CRYM 99.145437 Cd SMA 11027 Dopamine MT1G 0.212344 1.029377e-75 9.278317e-73 PosCor MT1G 72.032531 Cd SMA 11788 Dopamine GFAP -0.262491 4.203159e-116 2.146833e-112 NegCor GFAP 111.668202 Cd SMA 12343 Dopamine MBP -0.246967 1.403670e-102 2.688555e-99 NegCor MBP 98.570481 Cd SMA 13619 Dopamine NNAT 0.258008 4.219107e-112 1.616235e-108 PosCor NNAT 107.791496 Cd SMA 14392 Dopamine TSPAN7 0.239372 2.667464e-96 4.087356e-93 PosCor TSPAN7 92.388558 Cd SMA 14576 Dopamine PCDH11X 0.206412 1.480592e-71 1.194059e-68 PosCor PCDH11X 67.922974 Cd SMA 14624 Dopamine PLP1 -0.233789 7.979968e-92 9.405927e-89 NegCor PLP1 88.026598 Cd SMA 14768 Dopamine PNMA5 0.223717 4.790115e-84 4.587434e-81 PosCor PNMA5 80.338430 Cd SMA <pre><code>from scipy.stats import pearsonr\n\ndata_list = []\nfor region in sm_adata.obs['Region'].unique():    \n    df = sm_adata[sm_adata.obs['Region'] == region].obs\n    if df.shape[0] == 0:\n        continue\n    for gene in SMA_cor_df['gene'].tolist():\n        if gene not in df.columns:\n            continue\n        corr, p_value = pearsonr(df[dopamine], df[gene])\n        data_list.append((region, 'Dopamine', gene, corr, p_value))\ndf = pd.DataFrame(data_list, columns=['Region', 'dopamine', 'gene', 'rho', 'Pvalue'])\ndf['Method'] = 'SCrOFit'\nbench_cor_df = pd.concat([SMA_cor_df[df.columns], df])\nbench_cor_df['Type'] = bench_cor_df['Region'] + '(' + bench_cor_df['Method'] + ')'\nbench_cor_df['InvLog10Pvalue'] = -np.log10(bench_cor_df['Pvalue'])\n\nbench_cor_df = bench_cor_df[bench_cor_df['Pvalue'] &amp;lt; 0.05]\n\n\nfrom matplotlib.colors import Normalize\n\n# Normalize the color values to set the midpoint to zero\nz = bench_cor_df['rho']\nnorm = Normalize(vmin=-np.max(np.abs(z)), vmax=np.max(np.abs(z)))\n\n\nfig = plt.figure(figsize=(7, 1.8)) \nsns.scatterplot(\n    data=bench_cor_df.sort_values(by='rho'), \n    y=\"Type\", x=\"gene\", \n    #order=['Cd(SCrOFit)', 'Cd(SMA)', 'CI(SCrOFit)', 'ACB', 'SCrOFit'],\n    hue='rho', hue_norm=norm,\n    size='InvLog10Pvalue',\n    palette='coolwarm'\n)\nplt.xlabel(None)\nplt.xticks(rotation=45, ha='right')\nplt.ylabel(None)\nplt.legend().set_visible(False)  # Hide the legend\nplt.tight_layout()\nplt.show()\n</code></pre> <pre>\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\nFile ~/miniconda3/envs/dev/lib/python3.11/site-packages/pandas/core/indexes/base.py:3805, in Index.get_loc(self, key)\n   3804 try:\n-&gt; 3805     return self._engine.get_loc(casted_key)\n   3806 except KeyError as err:\n\nFile index.pyx:167, in pandas._libs.index.IndexEngine.get_loc()\n\nFile index.pyx:196, in pandas._libs.index.IndexEngine.get_loc()\n\nFile pandas/_libs/hashtable_class_helper.pxi:7081, in pandas._libs.hashtable.PyObjectHashTable.get_item()\n\nFile pandas/_libs/hashtable_class_helper.pxi:7089, in pandas._libs.hashtable.PyObjectHashTable.get_item()\n\nKeyError: 'Region'\n\nThe above exception was the direct cause of the following exception:\n\nKeyError                                  Traceback (most recent call last)\nCell In[23], line 4\n      1 from scipy.stats import pearsonr\n      3 data_list = []\n----&gt; 4 for region in sm_adata.obs['Region'].unique():    \n      5     df = sm_adata[sm_adata.obs['Region'] == region].obs\n      6     if df.shape[0] == 0:\n\nFile ~/miniconda3/envs/dev/lib/python3.11/site-packages/pandas/core/frame.py:4102, in DataFrame.__getitem__(self, key)\n   4100 if self.columns.nlevels &gt; 1:\n   4101     return self._getitem_multilevel(key)\n-&gt; 4102 indexer = self.columns.get_loc(key)\n   4103 if is_integer(indexer):\n   4104     indexer = [indexer]\n\nFile ~/miniconda3/envs/dev/lib/python3.11/site-packages/pandas/core/indexes/base.py:3812, in Index.get_loc(self, key)\n   3807     if isinstance(casted_key, slice) or (\n   3808         isinstance(casted_key, abc.Iterable)\n   3809         and any(isinstance(x, slice) for x in casted_key)\n   3810     ):\n   3811         raise InvalidIndexError(key)\n-&gt; 3812     raise KeyError(key) from err\n   3813 except TypeError:\n   3814     # If we have a listlike key, _check_indexing_error will raise\n   3815     #  InvalidIndexError. Otherwise we fall through and re-raise\n   3816     #  the TypeError.\n   3817     self._check_indexing_error(key)\n\nKeyError: 'Region'</pre> <pre><code>from scipy.stats import pearsonr\n\ndata_list = []\nfor cell_type in sm_adata.obs['Cell Type'].unique():    \n    df = sm_adata[sm_adata.obs['Cell Type'] == cell_type].obs\n    if df.shape[0] == 0:\n        continue\n    for gene in SMA_cor_df['gene'].tolist():\n        if gene not in df.columns:\n            continue\n        corr, p_value = pearsonr(df[dopamine], df[gene])\n        data_list.append((cell_type, 'Dopamine', gene, corr, p_value))\ncor_df = pd.DataFrame(data_list, columns=['Cell Type', 'dopamine', 'gene', 'rho', 'Pvalue'])\ncor_df['Method'] = 'SCrOFit'\ncor_df = cor_df[cor_df['Pvalue'] &amp;lt; 0.05]\ncor_df['InvLog10Pvalue'] = -np.log10(cor_df['Pvalue'])\n\n\nfig = plt.figure(figsize=(7,3)) \nz = cor_df['rho']\nnorm = Normalize(vmin=-np.max(np.abs(z)), vmax=np.max(np.abs(z)))\n\nsns.scatterplot(\n    data=cor_df.sort_values(by='rho'), \n    y=\"Cell Type\", x=\"gene\", \n    #order=['Cd(SCrOFit)', 'Cd(SMA)', 'CI(SCrOFit)', 'ACB', 'SCrOFit'],\n    hue='rho', hue_norm=norm,\n    size='InvLog10Pvalue',\n    palette='coolwarm'\n)\nplt.xlabel(None)\nplt.ylabel(None)\nplt.xticks(rotation=45, ha='right')\nplt.legend().set_visible(False)  # Hide the legend\nplt.tight_layout()\nplt.show()\n</code></pre> <pre>\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\nFile ~/miniconda3/envs/dev/lib/python3.11/site-packages/pandas/core/indexes/base.py:3805, in Index.get_loc(self, key)\n   3804 try:\n-&gt; 3805     return self._engine.get_loc(casted_key)\n   3806 except KeyError as err:\n\nFile index.pyx:167, in pandas._libs.index.IndexEngine.get_loc()\n\nFile index.pyx:196, in pandas._libs.index.IndexEngine.get_loc()\n\nFile pandas/_libs/hashtable_class_helper.pxi:7081, in pandas._libs.hashtable.PyObjectHashTable.get_item()\n\nFile pandas/_libs/hashtable_class_helper.pxi:7089, in pandas._libs.hashtable.PyObjectHashTable.get_item()\n\nKeyError: 'Cell Type'\n\nThe above exception was the direct cause of the following exception:\n\nKeyError                                  Traceback (most recent call last)\nCell In[24], line 4\n      1 from scipy.stats import pearsonr\n      3 data_list = []\n----&gt; 4 for cell_type in sm_adata.obs['Cell Type'].unique():    \n      5     df = sm_adata[sm_adata.obs['Cell Type'] == cell_type].obs\n      6     if df.shape[0] == 0:\n\nFile ~/miniconda3/envs/dev/lib/python3.11/site-packages/pandas/core/frame.py:4102, in DataFrame.__getitem__(self, key)\n   4100 if self.columns.nlevels &gt; 1:\n   4101     return self._getitem_multilevel(key)\n-&gt; 4102 indexer = self.columns.get_loc(key)\n   4103 if is_integer(indexer):\n   4104     indexer = [indexer]\n\nFile ~/miniconda3/envs/dev/lib/python3.11/site-packages/pandas/core/indexes/base.py:3812, in Index.get_loc(self, key)\n   3807     if isinstance(casted_key, slice) or (\n   3808         isinstance(casted_key, abc.Iterable)\n   3809         and any(isinstance(x, slice) for x in casted_key)\n   3810     ):\n   3811         raise InvalidIndexError(key)\n-&gt; 3812     raise KeyError(key) from err\n   3813 except TypeError:\n   3814     # If we have a listlike key, _check_indexing_error will raise\n   3815     #  InvalidIndexError. Otherwise we fall through and re-raise\n   3816     #  the TypeError.\n   3817     self._check_indexing_error(key)\n\nKeyError: 'Cell Type'</pre> <pre><code>bench_cor_df['Annotation'] = bench_cor_df['Region']\nbench_cor_df['Function Annotation'] = 'Region'\ncor_df['Annotation'] = cor_df['Cell Type']\ncor_df['Function Annotation'] = 'Cell Type'\n\ncols = ['Function Annotation', 'Annotation', 'dopamine', 'gene', 'rho', 'Pvalue', 'Method',\n       'InvLog10Pvalue']\ndf = pd.concat([bench_cor_df[cols], cor_df[cols]])\ndf = df.sort_values(by=['Function Annotation', 'Annotation', 'rho'], ascending=[False, True, True])\nz = df['rho']\nnorm = Normalize(vmin=-np.max(np.abs(z)), vmax=np.max(np.abs(z)))\n\nfig = plt.figure(figsize=(4,5)) \nsns.scatterplot(\n    data=df[df['Method'] == 'SCrOFit'], \n    x=\"Annotation\", y=\"gene\", \n    #order=['Cd(SCrOFit)', 'Cd(SMA)', 'CI(SCrOFit)', 'ACB', 'SCrOFit'],\n    hue='rho', hue_norm=norm,\n    size='InvLog10Pvalue',\n    palette='coolwarm'\n)\nplt.xlabel(None)\nplt.ylabel(None)\nplt.xticks(rotation=60, ha='right')\n#plt.legend().set_visible(False)  # Hide the legend\nplt.legend(loc=\"upper left\", bbox_to_anchor=(1, 1))\n#plt.tight_layout()\nplt.show()\n</code></pre> <pre><code>for gene in ['GFAP']:\n    fig = plt.figure(figsize=(5,5)) \n    adata = st_adata.copy()\n    adata.obs['Region'][adata.obs['Region'] != 'ACB'] = np.nan\n    sq.pl.spatial_scatter(adata, color='Region', img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=2) \n    plt.title('ACB')\n    plt.legend().set_visible(False)\n    plt.show()\n    fig = plt.figure(figsize=(5,5)) \n    adata[adata[adata.obs['Region'] != 'ACB'].obs_names, gene].X = np.nan\n    sq.pl.spatial_scatter(adata, color=gene, img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=2)  \n    plt.show()\n    fig = plt.figure(figsize=(5,5))   \n    adata = sm_adata.copy()\n    adata[adata[adata.obs['Region'] != 'ACB'].obs_names, 'mz_674.2805'].X = np.nan\n    sq.pl.spatial_scatter(adata, color='mz_674.2805', img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='After SCrOFit\\nST OCS', cmap='plasma', size=2)\n</code></pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/344954062.py:4: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\n  adata.obs['Region'][adata.obs['Region'] != 'ACB'] = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/344954062.py:12: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Region'] != 'ACB'].obs_names, gene].X = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/scipy/sparse/_index.py:210: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil and dok are more efficient.\n  self._set_arrayXarray(i, j, x)\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/344954062.py:19: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Region'] != 'ACB'].obs_names, 'mz_674.2805'].X = np.nan\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre><code>for gene in ['TF']:\n    fig = plt.figure(figsize=(5,5)) \n    adata = st_adata.copy()\n    adata.obs['Region'][adata.obs['Region'] != 'CI'] = np.nan\n    sq.pl.spatial_scatter(adata, color='Region', img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=2) \n    plt.title('CI')\n    plt.legend().set_visible(False)\n    plt.show()\n    fig = plt.figure(figsize=(5,5)) \n    adata[adata[adata.obs['Region'] != 'CI'].obs_names, gene].X = np.nan\n    sq.pl.spatial_scatter(adata, color=gene, img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=2)  \n    plt.show()\n    fig = plt.figure(figsize=(5,5))   \n    adata = sm_adata.copy()\n    adata[adata[adata.obs['Region'] != 'CI'].obs_names, 'mz_674.2805'].X = np.nan\n    sq.pl.spatial_scatter(adata, color='mz_674.2805', img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='After SCrOFit\\nST OCS', cmap='plasma', size=2)\n</code></pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/852264967.py:4: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\n  adata.obs['Region'][adata.obs['Region'] != 'CI'] = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/852264967.py:12: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Region'] != 'CI'].obs_names, gene].X = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/scipy/sparse/_index.py:210: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil and dok are more efficient.\n  self._set_arrayXarray(i, j, x)\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/852264967.py:19: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Region'] != 'CI'].obs_names, 'mz_674.2805'].X = np.nan\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre><code>for gene in ['NCDN', 'SCG2']:\n    fig = plt.figure(figsize=(5,5)) \n    adata = st_adata.copy()\n    adata.obs['Region'][adata.obs['Region'] != 'Cd'] = np.nan\n    sq.pl.spatial_scatter(adata, color='Region', img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=2) \n    plt.title('Cd')\n    plt.legend().set_visible(False)\n    plt.show()\n    fig = plt.figure(figsize=(5,5)) \n    adata[adata[adata.obs['Region'] != 'Cd'].obs_names, gene].X = np.nan\n    sq.pl.spatial_scatter(adata, color=gene, img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=2)  \n    plt.show()\n    fig = plt.figure(figsize=(5,5))   \n    adata = sm_adata.copy()\n    adata[adata[adata.obs['Region'] != 'Cd'].obs_names, 'mz_674.2805'].X = np.nan\n    sq.pl.spatial_scatter(adata, color='mz_674.2805', img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='After SCrOFit\\nST OCS', cmap='plasma', size=2)\n</code></pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/1562956874.py:4: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\n  adata.obs['Region'][adata.obs['Region'] != 'Cd'] = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/1562956874.py:12: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Region'] != 'Cd'].obs_names, gene].X = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/scipy/sparse/_index.py:210: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil and dok are more efficient.\n  self._set_arrayXarray(i, j, x)\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/1562956874.py:19: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Region'] != 'Cd'].obs_names, 'mz_674.2805'].X = np.nan\n/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/1562956874.py:4: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\n  adata.obs['Region'][adata.obs['Region'] != 'Cd'] = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/1562956874.py:12: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Region'] != 'Cd'].obs_names, gene].X = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/scipy/sparse/_index.py:210: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil and dok are more efficient.\n  self._set_arrayXarray(i, j, x)\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/1562956874.py:19: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Region'] != 'Cd'].obs_names, 'mz_674.2805'].X = np.nan\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre><code>for gene in ['MBP']:\n    fig = plt.figure(figsize=(5,5)) \n    adata = st_adata.copy()\n    adata.obs['Cell Type'][adata.obs['Cell Type'] != 'Astro'] = np.nan\n    sq.pl.spatial_scatter(adata, color='Cell Type', img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=2) \n    plt.title('Astro')\n    plt.legend().set_visible(False)\n    plt.show()\n    fig = plt.figure(figsize=(5,5)) \n    adata[adata[adata.obs['Cell Type'] != 'Astro'].obs_names, gene].X = np.nan\n    sq.pl.spatial_scatter(adata, color=gene, img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=2)  \n    plt.show()\n    fig = plt.figure(figsize=(5,5))   \n    adata = sm_adata.copy()\n    adata[adata[adata.obs['Cell Type'] != 'Astro'].obs_names, 'mz_674.2805'].X = np.nan\n    sq.pl.spatial_scatter(adata, color='mz_674.2805', img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='After SCrOFit\\nST OCS', cmap='plasma', size=2)\n</code></pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_88575/553887567.py:4: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\n  adata.obs['Cell Type'][adata.obs['Cell Type'] != 'Astro'] = np.nan\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:946: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/scipy/sparse/_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\n  self._set_arrayXarray(i, j, x)\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre><code>for gene in ['SCG2', 'NCDN']:\n    fig = plt.figure(figsize=(5,5)) \n    adata = st_adata.copy()\n    adata.obs['Cell Type'][adata.obs['Cell Type'] != 'MSN.D1.TacPosB'] = np.nan\n    sq.pl.spatial_scatter(adata, color='Cell Type', img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=2) \n    plt.title('MSN.D1.TacPosB')\n    plt.legend().set_visible(False)\n    plt.show()\n    fig = plt.figure(figsize=(5,5)) \n    adata[adata[adata.obs['Cell Type'] != 'MSN.D1.TacPosB'].obs_names, gene].X = np.nan\n    sq.pl.spatial_scatter(adata, color=gene, img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=2)  \n    plt.show()\n    fig = plt.figure(figsize=(5,5))   \n    adata = sm_adata.copy()\n    adata[adata[adata.obs['Cell Type'] != 'MSN.D1.TacPosB'].obs_names, 'mz_674.2805'].X = np.nan\n    sq.pl.spatial_scatter(adata, color='mz_674.2805', img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='After SCrOFit\\nST OCS', cmap='plasma', size=2)\n</code></pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/1167743081.py:4: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\n  adata.obs['Cell Type'][adata.obs['Cell Type'] != 'MSN.D1.TacPosB'] = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/1167743081.py:12: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Cell Type'] != 'MSN.D1.TacPosB'].obs_names, gene].X = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/scipy/sparse/_index.py:210: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil and dok are more efficient.\n  self._set_arrayXarray(i, j, x)\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/1167743081.py:19: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Cell Type'] != 'MSN.D1.TacPosB'].obs_names, 'mz_674.2805'].X = np.nan\n/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/1167743081.py:4: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\n  adata.obs['Cell Type'][adata.obs['Cell Type'] != 'MSN.D1.TacPosB'] = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/1167743081.py:12: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Cell Type'] != 'MSN.D1.TacPosB'].obs_names, gene].X = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/scipy/sparse/_index.py:210: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil and dok are more efficient.\n  self._set_arrayXarray(i, j, x)\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/1167743081.py:19: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Cell Type'] != 'MSN.D1.TacPosB'].obs_names, 'mz_674.2805'].X = np.nan\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre><code>for gene in ['PLP1']:\n    fig = plt.figure(figsize=(5,5)) \n    adata = st_adata.copy()\n    adata.obs['Cell Type'][adata.obs['Cell Type'] != 'Oligo'] = np.nan\n    sq.pl.spatial_scatter(adata, color='Cell Type', img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=2) \n    plt.title('Oligo')\n    plt.legend().set_visible(False)\n    plt.show()\n    fig = plt.figure(figsize=(5,5)) \n    adata[adata[adata.obs['Cell Type'] != 'Oligo'].obs_names, gene].X = np.nan\n    sq.pl.spatial_scatter(adata, color=gene, img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='SMA\\nST OCS', cmap='Spectral_r', size=2)  \n    plt.show()\n    fig = plt.figure(figsize=(5,5))   \n    adata = sm_adata.copy()\n    adata[adata[adata.obs['Cell Type'] != 'Oligo'].obs_names, 'mz_674.2805'].X = np.nan\n    sq.pl.spatial_scatter(adata, color='mz_674.2805', img=True, shape=None, \n                          library_id=sample,\n                      spatial_key='After SCrOFit\\nST OCS', cmap='plasma', size=2)\n</code></pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/4025993123.py:4: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\n  adata.obs['Cell Type'][adata.obs['Cell Type'] != 'Oligo'] = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/4025993123.py:12: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Cell Type'] != 'Oligo'].obs_names, gene].X = np.nan\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/scipy/sparse/_index.py:210: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil and dok are more efficient.\n  self._set_arrayXarray(i, j, x)\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_69196/4025993123.py:19: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n  adata[adata[adata.obs['Cell Type'] != 'Oligo'].obs_names, 'mz_674.2805'].X = np.nan\n</code>\n</pre> <pre>\n<code>&lt;Figure size 500x500 with 0 Axes&gt;</code>\n</pre> <pre><code>bench_cor_df[bench_cor_df['gene'].isin(['GFAP', 'TF', 'NCDN', 'SCG2', 'MBP', 'PLP1'])]\n</code></pre> Region dopamine gene rho Pvalue Method Type InvLog10Pvalue Annotation Function Annotation 348 Cd Dopamine NCDN 0.244814 8.910519e-101 SMA Cd(SMA) 100.050097 Cd Region 2368 Cd Dopamine SCG2 0.326443 4.317302e-182 SMA Cd(SMA) 181.364788 Cd Region 3064 Cd Dopamine TF -0.234649 1.659563e-92 SMA Cd(SMA) 91.780006 Cd Region 11788 Cd Dopamine GFAP -0.262491 4.203159e-116 SMA Cd(SMA) 115.376424 Cd Region 12343 Cd Dopamine MBP -0.246967 1.403670e-102 SMA Cd(SMA) 101.852735 Cd Region 14624 Cd Dopamine PLP1 -0.233789 7.979968e-92 SMA Cd(SMA) 91.097999 Cd Region 0 Cd Dopamine NCDN 0.232739 4.943606e-95 SCRoFit Cd(SCRoFit) 94.305956 Cd Region 5 Cd Dopamine SCG2 0.191127 3.980567e-64 SCRoFit Cd(SCRoFit) 63.400055 Cd Region 7 Cd Dopamine TF -0.139111 1.641450e-34 SCRoFit Cd(SCRoFit) 33.784772 Cd Region 15 Cd Dopamine GFAP -0.125625 2.093631e-28 SCRoFit Cd(SCRoFit) 27.679100 Cd Region 16 Cd Dopamine MBP -0.180309 3.695282e-57 SCRoFit Cd(SCRoFit) 56.432352 Cd Region 20 Cd Dopamine PLP1 -0.151742 8.258044e-41 SCRoFit Cd(SCRoFit) 40.083123 Cd Region 21 CI Dopamine NCDN 0.040430 2.791577e-02 SCRoFit CI(SCRoFit) 1.554150 CI Region 26 CI Dopamine SCG2 0.130330 1.123064e-12 SCRoFit CI(SCRoFit) 11.949596 CI Region 28 CI Dopamine TF -0.505195 2.413843e-191 SCRoFit CI(SCRoFit) 190.617291 CI Region 36 CI Dopamine GFAP -0.454083 2.181329e-150 SCRoFit CI(SCRoFit) 149.661279 CI Region 37 CI Dopamine MBP -0.459162 3.749387e-154 SCRoFit CI(SCRoFit) 153.426040 CI Region 41 CI Dopamine PLP1 -0.475893 5.134923e-167 SCRoFit CI(SCRoFit) 166.289466 CI Region 42 ACB Dopamine NCDN 0.169089 5.922076e-12 SCRoFit ACB(SCRoFit) 11.227526 ACB Region 47 ACB Dopamine SCG2 0.131191 1.016842e-07 SCRoFit ACB(SCRoFit) 6.992747 ACB Region 49 ACB Dopamine TF -0.211590 5.277959e-18 SCRoFit ACB(SCRoFit) 17.277534 ACB Region 57 ACB Dopamine GFAP -0.557126 5.876002e-134 SCRoFit ACB(SCRoFit) 133.230918 ACB Region 58 ACB Dopamine MBP -0.291734 1.930618e-33 SCRoFit ACB(SCRoFit) 32.714304 ACB Region 62 ACB Dopamine PLP1 -0.147703 1.963924e-09 SCRoFit ACB(SCRoFit) 8.706875 ACB Region <pre><code>%autoreload\nfor block, obj in obj_dict.items():\n    print(block)\n    obj.check_slides(figsize=(12, 10), fig_fn=f'{block}.png')\n</code></pre> <pre>\n<code>A1\nB1\nC1\nD1\n</code>\n</pre> <pre><code>%autoreload\nfrom src.embedding import embedding\n\nobj = obj_dict['A1']\nembedding(obj, 'ST', 'SM', 'MCMF')\n</code></pre> <pre>\n<code>(4735, 12847)\n(4030, 1538)\n4731\n4029\n4.2195077\n19.413069096174027\n</code>\n</pre>"},{"location":"tutorial/analysis_SMA_after_SCrOFit/","title":"Analyze SMA data after SCrOFit","text":"<p>This notebook demosntrate how to analyze the SMA data after running SCrOFit.</p> <pre><code>%load_ext autoreload\n</code></pre> <pre><code>%autoreload\nimport anndata as ad\nimport scanpy as sc\nimport matplotlib.pyplot as plt\nimport squidpy as sq\nimport numpy as np\n\nimport sys\nsys.path.append('../../')\nimport scrofit.plotting as pl\n\nsample = 'V11T17-102'\nin_dir = f'../../../data/MSA_data/{sample}'\n\nst_adata = ad.read_h5ad(f'{in_dir}/{sample}_st_pp.adata')\nsm_adata = ad.read_h5ad(f'{in_dir}/{sample}_sm_pp.adata')\nmdata = ad.read_h5ad(f'{in_dir}/{sample}_m_pp.adata')\n\n\nsm_adata.obsm['SMA\\nSM OCS'] = sm_adata.obsm['spatial']\nst_adata.obsm['SMA\\nST OCS'] = st_adata.obsm['spatial']\nsc.pl.spatial(st_adata, basis='SMA\\nST OCS')\n\n\n\nmymap = {'unk': np.nan, 'unk2': np.nan}\nst_adata.obs['Region'] = st_adata.obs['RegionLoupe'].apply(lambda x: mymap.get(x, x))\npl.ocs_spatial_scatter(st_adata, 'ST', color=['Region'], img=True, shape=None, library_id=sample,\n                      size=0.5)\nmdata.obs['ST_Region'] = mdata.obs['ST_RegionLoupe'].apply(lambda x: mymap.get(x, x))\npl.ccs_spatial_scatter(mdata, 'ST', color=['ST_Region'], img=True, shape=None, library_id=sample,\n                      size=0.5)\npl.embed(mdata, color='ST_Region', figsize=(2.8, 3))\npl.ocs_spatial_scatter(st_adata, 'ST', color=['dopamine'], img=True, shape=None, library_id=sample,\n                      size=0.5, palette='Set2')\n\npl.ccs_spatial_scatter(mdata, 'ST', color=['ST_dopamine'], img=True, shape=None, library_id=sample,\n                       size=0.5, palette='Set2')\n</code></pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\anndata\\utils.py:434: FutureWarning: Importing read_text from `anndata` is deprecated. Import anndata.io.read_text instead.\n  warnings.warn(msg, FutureWarning)\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\anndata\\_core\\anndata.py:1756: UserWarning: Observation names are not unique. To make them unique, call `.obs_names_make_unique`.\nC:\\Users\\User\\AppData\\Local\\Temp\\ipykernel_24800\\1202873127.py:22: FutureWarning: Use `squidpy.pl.spatial_scatter` instead.\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre><code>sm_adata\n</code></pre> <pre>\n<code>AnnData object with n_obs \u00d7 n_vars = 15813 \u00d7 1538\n    obs: 'sample', 'block', 'n_genes', 'ST_RegionLoupe', 'ST_MSN.D2.PenkNeg_5', 'ST_MSN.D1.TacNeg_3', 'ST_MSN.D2_C_18', 'ST_MSN.D1.TacPosB_6', 'ST_MSN.D1.TacPosA_9', 'ST_MSN.D2.PenkPos_2', 'ST_ST_id', 'LY6H', 'THY1', 'VSNL1', 'PCDH11X', 'MBP', 'PLP1', 'CHN1', 'SYNPR', 'NCDN', 'MAP2', 'GDA', 'HPCAL4', 'RTN1', 'NNAT', 'TSPAN7', 'PEG10', 'SCG2', 'TF', 'CRYM', 'GFAP', 'MT1G'\n    uns: 'spatial'\n    obsm: 'XY_spatial_euclidean_dist', 'mappingflow_MCMF', 'spatial', 'spatial_MCMF_map', 'spatial_normalized', 'spatial_rir', 'spatial_rir_filtered', 'SMA\\nSM OCS'\n    layers: 'log1p', 'raw'</code>\n</pre> <pre><code>%autoreload\nfor color in st_adata.obs.columns:\n    if not color.startswith('MSN'):\n        continue\n    pl.ocs_spatial_scatter(st_adata, 'ST', color=color, img=True, shape=None, \n                          library_id=sample, cmap='OrRd', size=0.5)\n</code></pre> <pre><code>%autoreload\nfor gene in ['SCG2', 'CHN1', 'NNAT', 'GFAP', 'MBP', 'TF', 'PLP1']:\n    pl.ocs_spatial_scatter(st_adata, 'ST', color=gene, img=True, shape=None, \n                          library_id=sample, cmap='Spectral_r', size=0.5)\n</code></pre> <pre><code>%autoreload\npl.ocs_spatial_scatter(sm_adata, 'SM', color='mz_674.2805', img=False, shape=None, library_id=sample,\n                      cmap='viridis', size=0.5)\npl.ccs_spatial_scatter(mdata, 'SM', color='mz_674.2805', img=False, shape=None, library_id=sample,\n                      cmap='plasma', size=0.5)\n\npl.embed(mdata, color='mz_674.2805', cmap='plasma', figsize=(3.2, 3), colorbar_loc='right')\n</code></pre> <pre><code>%autoreload\n\npl.ocs_spatial_scatter(st_adata, 'ST', color=['Cell_Type'], img=True, shape=None, library_id=sample,\n                       palette='Accent', size=0.5)\npl.ccs_spatial_scatter(mdata, 'ST', color=['ST_Cell_Type'], img=True, shape=None, library_id=sample,\n                       palette='Accent', size=0.5)\npl.embed(mdata, color='ST_Cell_Type', palette='Accent', figsize=(2.8, 3))\n</code></pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre><code>st_adata.obsm\n</code></pre> <pre>\n<code>AxisArrays with keys: spatial, spatial_normalized, spatial_rir, spatial_rir_filtered, SMA\nST OCS</code>\n</pre> <pre><code>mdata.obsm\n</code></pre> <pre>\n<code>AxisArrays with keys: SM_XY_spatial_euclidean_dist, SM_mappingflow_MCMF, SM_spatial, SM_spatial_MCMF_map, SM_spatial_normalized, SM_spatial_rir, SM_spatial_rir_filtered, ST_spatial, ST_spatial_normalized, ST_spatial_rir, ST_spatial_rir_filtered, X_pca, X_umap</code>\n</pre> <pre><code>%autoreload\n\nx_min=35000\nx_max=x_min+5000\ny_min=35000\ny_max=y_min+5000\n\npl.ccs_spatial_zoom(\n    st_adata, mdata,\n    metabolite=\"mz_674.2805\",\n    cell_type_col=\"Cell_Type\",\n    st_coord_key=\"spatial_rir\",\n    sm_coord_key=\"SM_spatial_rir\",\n    cell_dot_size=250,\n    x_min=x_min, x_max=x_max, \n    y_min=y_min, y_max=y_max,\n    figsize=(4,4),\n    st_cmap=\"Accent\",\n    m_cmap='plasma'    \n)\n</code></pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:233: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.\n</code>\n</pre> <pre><code>%autoreload\n\npl.ccs_spatial_zoom(\n    st_adata, mdata,\n    metabolite=\"mz_674.2805\",\n    cell_type_col=\"Region\",\n    st_coord_key=\"spatial_rir\",\n    sm_coord_key=\"SM_spatial_rir\",\n    cell_dot_size=250,\n    gene_dot_size=10,\n    x_min=x_min, x_max=x_max, \n    y_min=y_min, y_max=y_max,\n    figsize=(4,4),\n    st_cmap=None,\n    m_cmap='plasma'\n)\n</code></pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:233: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.\n</code>\n</pre> <pre><code>%autoreload\nimport seaborn as sns\nimport pandas as pd\n\ndopamine = 'Dopamine (mz_674.2805)'\nmymap = {'unk': np.nan, 'unk2': np.nan}\nsm_adata.obs['Region'] = sm_adata.obs['ST_RegionLoupe'].apply(lambda x: mymap.get(x, x))\nmymap = st_adata.obs['Cell_Type'].to_dict()\nsm_adata.obs['Cell_Type'] = sm_adata.obs['ST_ST_id'].apply(lambda x: mymap[x])\nsm_adata.obs['New_Cell_Type']  = sm_adata.obs['Cell_Type'].apply(lambda x: np.nan if x in ['Inhib', 'Inhib_MSN'] else x)\ncustom_order = ['MSN', 'Mi.MiR.Ma', 'Astro', 'OPC', 'Oligo']\nsm_adata.obs['New_Cell_Type']  = sm_adata.obs['New_Cell_Type'].astype(pd.CategoricalDtype(categories=custom_order, ordered=True))\n\n\nsm_adata.obs[dopamine] = dict(zip(sm_adata.obs.index, sm_adata[:, 'mz_674.2805'].X.reshape(-1)))\n\ncompare_type = 'New_Cell_Type'\ncomparisons = [\n    (\"MSN\", \"Astro\"),    \n    (\"MSN\", \"Mi.MiR.Ma\"),    \n    (\"MSN\", \"OPC\"),    \n    (\"MSN\", \"Oligo\"),     \n]\nbase_colors = sns.color_palette('Accent', 8).as_hex()\npalette = dict(zip(np.sort(sm_adata.obs['Cell_Type'].dropna().unique()), base_colors[:3] + base_colors[-4:]))\npl.violin(sm_adata, compare_type, dopamine, comparisons,\n             fig_size=(3, 3), \n             palette=palette,\n             text_x_angle=20)\n</code></pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:296: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.\n</code>\n</pre> <pre><code>\n</code></pre> <pre><code>%autoreload\ncompare_type = 'Region'\ncomparisons = [\n    #(\"ACB\", \"CI\"),    \n    #(\"ACB\", \"Cd\"),    \n    (\"Cd\", \"CI\"),    \n]\npl.violin(sm_adata[sm_adata.obs['Region'] != 'ACB'], compare_type, dopamine, comparisons,\n             fig_size=(3, 3),\n             text_x_angle=90,\n             palette=sc.pl.palettes.default_20[1:])\n</code></pre> <pre><code>import pandas as pd\ndf = pd.read_csv('../../../data/MSA_data/corHstr_onlyCdSpots.csv', index_col=0)\nSMA_cor_df = df[(df['FDR'] &amp;lt; 0.05) &amp;amp; (df['rho'].abs() &amp;gt; 0.2)]\n\nSMA_cor_df['Region'] = 'Cd'\nSMA_cor_df['Method'] = 'SMA'\nSMA_cor_df\n</code></pre> <pre>\n<code>C:\\Users\\User\\AppData\\Local\\Temp\\ipykernel_24800\\3254590528.py:5: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\nC:\\Users\\User\\AppData\\Local\\Temp\\ipykernel_24800\\3254590528.py:6: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n</code>\n</pre> dopamine gene rho Pvalue FDR sig corlabel InvLog10FDR Region Method 348 Dopamine NCDN 0.244814 8.910519e-101 1.517065e-97 PosCor NCDN 96.818996 Cd SMA 395 Dopamine HPCAL4 0.210742 1.407301e-74 1.198004e-71 PosCor HPCAL4 70.921542 Cd SMA 1550 Dopamine VSNL1 0.236569 4.872488e-94 6.787375e-91 PosCor VSNL1 90.168298 Cd SMA 2148 Dopamine CHN1 0.263871 2.375161e-117 1.819730e-113 PosCor CHN1 112.739993 Cd SMA 2290 Dopamine MAP2 0.200022 3.214671e-67 2.239018e-64 PosCor MAP2 63.649942 Cd SMA 2368 Dopamine SCG2 0.326443 4.317302e-182 6.615401e-178 PosCor SCG2 177.179444 Cd SMA 2845 Dopamine SYNPR 0.255258 1.098729e-109 3.367164e-106 PosCor SYNPR 105.472736 Cd SMA 3064 Dopamine TF -0.234649 1.659563e-92 2.119124e-89 NegCor TF 88.673844 Cd SMA 5685 Dopamine PEG10 0.229432 2.058726e-88 2.253275e-85 PosCor PEG10 84.647186 Cd SMA 6483 Dopamine LY6H 0.229322 2.504924e-88 2.558863e-85 PosCor LY6H 84.591953 Cd SMA 6715 Dopamine GDA 0.204074 5.952055e-70 4.343016e-67 PosCor GDA 66.362209 Cd SMA 8509 Dopamine THY1 0.250591 1.185839e-105 3.028434e-102 PosCor THY1 101.518782 Cd SMA 9885 Dopamine RTN1 0.205265 9.126335e-71 6.992142e-68 PosCor RTN1 67.155390 Cd SMA 10849 Dopamine CRYM 0.247718 3.268268e-103 7.154239e-100 PosCor CRYM 99.145437 Cd SMA 11027 Dopamine MT1G 0.212344 1.029377e-75 9.278317e-73 PosCor MT1G 72.032531 Cd SMA 11788 Dopamine GFAP -0.262491 4.203159e-116 2.146833e-112 NegCor GFAP 111.668202 Cd SMA 12343 Dopamine MBP -0.246967 1.403670e-102 2.688555e-99 NegCor MBP 98.570481 Cd SMA 13619 Dopamine NNAT 0.258008 4.219107e-112 1.616235e-108 PosCor NNAT 107.791496 Cd SMA 14392 Dopamine TSPAN7 0.239372 2.667464e-96 4.087356e-93 PosCor TSPAN7 92.388558 Cd SMA 14576 Dopamine PCDH11X 0.206412 1.480592e-71 1.194059e-68 PosCor PCDH11X 67.922974 Cd SMA 14624 Dopamine PLP1 -0.233789 7.979968e-92 9.405927e-89 NegCor PLP1 88.026598 Cd SMA 14768 Dopamine PNMA5 0.223717 4.790115e-84 4.587434e-81 PosCor PNMA5 80.338430 Cd SMA <pre><code>from scipy.stats import pearsonr\n\ndata_list = []\nfor region in sm_adata.obs['Region'].unique():    \n    df = sm_adata[sm_adata.obs['Region'] == region].obs\n    if df.shape[0] == 0:\n        continue\n    for gene in SMA_cor_df['gene'].tolist():\n        if gene not in df.columns:\n            continue\n        corr, p_value = pearsonr(df[dopamine], df[gene])\n        data_list.append((region, 'Dopamine', gene, corr, p_value))\ndf = pd.DataFrame(data_list, columns=['Region', 'dopamine', 'gene', 'rho', 'Pvalue'])\ndf['Method'] = 'SCRoFit'\nbench_cor_df = pd.concat([SMA_cor_df[df.columns], df])\nbench_cor_df['Type'] = bench_cor_df['Region'] + '(' + bench_cor_df['Method'] + ')'\nbench_cor_df['InvLog10Pvalue'] = -np.log10(bench_cor_df['Pvalue'])\n\nbench_cor_df = bench_cor_df[bench_cor_df['Pvalue'] &amp;lt; 0.05]\n\n\nfrom matplotlib.colors import Normalize\n\n# Normalize the color values to set the midpoint to zero\nz = bench_cor_df['rho']\nnorm = Normalize(vmin=-np.max(np.abs(z)), vmax=np.max(np.abs(z)))\n\n\nfig = plt.figure(figsize=(7, 1.8)) \nsns.scatterplot(\n    data=bench_cor_df.sort_values(by='rho'), \n    y=\"Type\", x=\"gene\", \n    #order=['Cd(SCRoFit)', 'Cd(SMA)', 'CI(SCRoFit)', 'ACB', 'SCRoFit'],\n    hue='rho', hue_norm=norm,\n    size='InvLog10Pvalue',\n    palette='coolwarm'\n)\nplt.xlabel(None)\nplt.xticks(rotation=45, ha='right')\nplt.ylabel(None)\nplt.legend().set_visible(False)  # Hide the legend\nplt.tight_layout()\nplt.show()\n</code></pre> <pre><code>from scipy.stats import pearsonr\n\ndata_list = []\nfor cell_type in sm_adata.obs['Cell_Type'].unique():    \n    df = sm_adata[sm_adata.obs['Cell_Type'] == cell_type].obs\n    if df.shape[0] == 0:\n        continue\n    for gene in SMA_cor_df['gene'].tolist():\n        if gene not in df.columns:\n            continue\n        corr, p_value = pearsonr(df[dopamine], df[gene])\n        data_list.append((cell_type, 'Dopamine', gene, corr, p_value))\ncor_df = pd.DataFrame(data_list, columns=['Cell Type', 'dopamine', 'gene', 'rho', 'Pvalue'])\ncor_df['Method'] = 'SCRoFit'\ncor_df = cor_df[cor_df['Pvalue'] &amp;lt; 0.05]\ncor_df['InvLog10Pvalue'] = -np.log10(cor_df['Pvalue'])\n\n\nfig = plt.figure(figsize=(7,3)) \nz = cor_df['rho']\nnorm = Normalize(vmin=-np.max(np.abs(z)), vmax=np.max(np.abs(z)))\n\nsns.scatterplot(\n    data=cor_df.sort_values(by='rho'), \n    y=\"Cell Type\", x=\"gene\", \n    #order=['Cd(SCRoFit)', 'Cd(SMA)', 'CI(SCRoFit)', 'ACB', 'SCRoFit'],\n    hue='rho', hue_norm=norm,\n    size='InvLog10Pvalue',\n    palette='coolwarm'\n)\nplt.xlabel(None)\nplt.ylabel(None)\nplt.xticks(rotation=45, ha='right')\nplt.legend().set_visible(False)  # Hide the legend\nplt.tight_layout()\nplt.show()\n</code></pre> <pre>\n<code>C:\\Users\\User\\AppData\\Local\\Temp\\ipykernel_24800\\3588643302.py:11: ConstantInputWarning: An input array is constant; the correlation coefficient is not defined.\n</code>\n</pre> <pre><code>bench_cor_df['Annotation'] = bench_cor_df['Region']\nbench_cor_df['Function Annotation'] = 'Region'\ncor_df['Annotation'] = cor_df['Cell Type']\ncor_df['Function Annotation'] = 'Cell Type'\n\ncols = ['Function Annotation', 'Annotation', 'dopamine', 'gene', 'rho', 'Pvalue', 'Method',\n       'InvLog10Pvalue']\ndf = pd.concat([bench_cor_df[cols], cor_df[cols]])\ndf = df.sort_values(by=['Function Annotation', 'Annotation', 'rho'], ascending=[False, True, True])\nz = df['rho']\nnorm = Normalize(vmin=-np.max(np.abs(z)), vmax=np.max(np.abs(z)))\n\nfig = plt.figure(figsize=(4,5)) \nsns.scatterplot(\n    data=df[df['Method'] == 'SCRoFit'], \n    x=\"Annotation\", y=\"gene\", \n    #order=['Cd(SCRoFit)', 'Cd(SMA)', 'CI(SCRoFit)', 'ACB', 'SCRoFit'],\n    hue='rho', hue_norm=norm,\n    size='InvLog10Pvalue',\n    palette='coolwarm'\n)\nplt.xlabel(None)\nplt.ylabel(None)\nplt.xticks(rotation=60, ha='right')\n#plt.legend().set_visible(False)  # Hide the legend\nplt.legend(loc=\"upper left\", bbox_to_anchor=(1, 1))\n#plt.tight_layout()\nplt.show()\n</code></pre> <pre><code>import pandas as pd\nimport numpy as np\nfrom plotnine import *\n\ndf = df.sort_values(\n    by=['Function Annotation', 'Annotation', 'rho'],\n    ascending=[False, True, True]\n).copy()\n\ndf['gene'] = pd.Categorical(df['gene'], categories=df['gene'].unique(), ordered=True)\ndf = df[df['Annotation'].isin(['CI', 'Cd', 'MSN', 'Astro', 'OPC', 'Oligo'])]\ndf['Annotation'] = pd.Categorical(df['Annotation'],categories=['CI', 'Cd', 'MSN', 'Astro', 'OPC', 'Oligo'],ordered=True)\n\nmax_abs = df['rho'].abs().max()\np = (\n    ggplot(df[df['Method'] == 'SCRoFit'],\n           aes(y='Annotation', x='gene',\n               color='rho',\n               size='InvLog10Pvalue'))\n    + facet_grid('Function Annotation ~ .', \n                 scales='free', space='free')\n    + geom_point()\n    + scale_color_gradient2(\n        low=\"blue\", mid=\"white\", high=\"red\",\n        midpoint=0,\n        limits=(-max_abs, max_abs)\n      )\n    + scale_size_area(max_size=5)\n    + theme_bw()\n    + theme(\n        figure_size=(5, 4),  \n        axis_text_y=element_text(angle=45, hjust=1),\n        axis_text_x=element_text(angle=90, hjust=-1),\n        strip_background=element_blank(),\n      )\n    + labs(\n        color='rho',\n        size='-log10(p)',\n        x='',\n        y=''\n      )   \n)\n\np\n</code></pre> <pre><code>st_adata[st_adata.obs['Region'] == 'ACB'].obsm['spatial_rir'].copy().min(axis=0), \\\nst_adata[st_adata.obs['Region'] == 'ACB'].obsm['spatial_rir'].copy().max(axis=0)\n</code></pre> <pre>\n<code>(array([  5396, 107920], dtype=int64), array([ 42228, 157478], dtype=int64))</code>\n</pre> <pre><code>%autoreload\n\nx_min = 17000\nx_max = x_min + 5000\ny_min = 120000\ny_max = y_min + 5000\n# Usage example\npl.ccs_spatial_zoom(\n    st_adata, mdata,\n    metabolite=\"mz_674.2805\", \n    gene=\"GFAP\",\n    cell_type_col=\"Region\",\n    st_coord_key=\"spatial_rir\",\n    sm_coord_key=\"SM_spatial_rir\",\n    cell_dot_size=250,\n    gene_dot_size=10,\n    x_min=x_min, x_max=x_max, \n    y_min=y_min, y_max=y_max,\n    figsize=(4, 4),\n    st_cmap=None,\n    g_cmap='Spectral_r',\n    m_cmap='plasma'\n)\n</code></pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:233: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.\n</code>\n</pre> <pre><code>%autoreload\n\npl.plot_gene_cell_type(st_adata, mdata, 'GFAP', 'Region', 'ACB')\n</code></pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:367: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:370: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\anndata\\_core\\anndata.py:1756: UserWarning: Observation names are not unique. To make them unique, call `.obs_names_make_unique`.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:375: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:376: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:377: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n</code>\n</pre> <pre><code>print(st_adata[st_adata.obs['Region'] == 'CI'].obsm['spatial_rir'].copy().min(axis=0), \\\nst_adata[st_adata.obs['Region'] == 'CI'].obsm['spatial_rir'].copy().max(axis=0))\n\nx_min = 30120\nx_max = x_min + 5000\ny_min = 80000\ny_max = y_min + 5000\n\npl.ccs_spatial_zoom(\n    st_adata, mdata,\n    metabolite=\"mz_674.2805\", \n    gene=\"TF\",\n    cell_type_col=\"Region\",\n    st_coord_key=\"spatial_rir\",\n    sm_coord_key=\"SM_spatial_rir\",\n    cell_dot_size=250,\n    gene_dot_size=10,\n    x_min=x_min, x_max=x_max, \n    y_min=y_min, y_max=y_max,\n    figsize=(4, 4),\n    st_cmap=None,\n    g_cmap='Spectral_r',\n    m_cmap='plasma'\n)\n</code></pre> <pre>\n<code>[25120  3341] [ 42534 131249]\n</code>\n</pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:233: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.\n</code>\n</pre> <pre><code>%autoreload\npl.plot_gene_cell_type(st_adata, mdata, 'TF', 'Region', 'CI')\n</code></pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:367: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:370: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\anndata\\_core\\anndata.py:1756: UserWarning: Observation names are not unique. To make them unique, call `.obs_names_make_unique`.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:375: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:376: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:377: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n</code>\n</pre> <pre><code>%autoreload\npl.plot_gene_cell_type(st_adata, mdata, 'NCDN', 'Region', 'Cd')\n</code></pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:367: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:370: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\anndata\\_core\\anndata.py:1756: UserWarning: Observation names are not unique. To make them unique, call `.obs_names_make_unique`.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:375: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:376: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:377: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n</code>\n</pre> <pre><code>%autoreload\npl.plot_gene_cell_type(st_adata, mdata, 'SCG2', 'Region', 'Cd')\n</code></pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:367: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:370: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\anndata\\_core\\anndata.py:1756: UserWarning: Observation names are not unique. To make them unique, call `.obs_names_make_unique`.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:375: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:376: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:377: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n</code>\n</pre> <pre><code>%autoreload\nprint(st_adata[st_adata.obs['Cell_Type'] == 'Astro'].obsm['spatial_rir'].copy().min(axis=0), \\\nst_adata[st_adata.obs['Cell_Type'] == 'Astro'].obsm['spatial_rir'].copy().max(axis=0))\n\nx_min = 15000\nx_max = x_min + 5000\ny_min = 150000\ny_max = y_min + 5000\n# Usage example\npl.ccs_spatial_zoom(\n    st_adata, mdata,\n    metabolite=\"mz_674.2805\", \n    gene=\"MBP\",\n    cell_type_col=\"Cell_Type\",\n    st_coord_key=\"spatial_rir\",\n    sm_coord_key=\"SM_spatial_rir\",\n    cell_dot_size=250,\n    gene_dot_size=10,\n    x_min=x_min, x_max=x_max, \n    y_min=y_min, y_max=y_max,\n    figsize=(4, 4),\n    st_cmap='Accent',\n    g_cmap='Spectral_r',\n    m_cmap='plasma'\n)\n</code></pre> <pre>\n<code>[5256 3777] [ 42121 176669]\n</code>\n</pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:233: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.\n</code>\n</pre> <pre><code>%autoreload\npl.plot_gene_cell_type(st_adata, mdata, 'MBP', 'Cell_Type', 'Astro')\n</code></pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:367: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:370: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\anndata\\_core\\anndata.py:1756: UserWarning: Observation names are not unique. To make them unique, call `.obs_names_make_unique`.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:375: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:376: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:377: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n</code>\n</pre> <pre><code>%autoreload\npl.plot_gene_cell_type(st_adata, mdata, 'SCG2', 'Cell_Type', 'MSN')\n</code></pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:367: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:370: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\anndata\\_core\\anndata.py:1756: UserWarning: Observation names are not unique. To make them unique, call `.obs_names_make_unique`.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:375: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:376: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:377: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n</code>\n</pre> <pre><code>%autoreload\nprint(st_adata[st_adata.obs['Cell_Type'] == 'MSN'].obsm['spatial_rir'].copy().min(axis=0), \\\nst_adata[st_adata.obs['Cell_Type'] == 'MSN'].obsm['spatial_rir'].copy().max(axis=0))\n\nx_min = 25120  \nx_max = x_min + 5000\ny_min = 100000\ny_max = y_min + 5000\n# Usage example\npl.ccs_spatial_zoom(\n    st_adata, mdata,\n    metabolite=\"mz_674.2805\", \n    gene=\"NCDN\",\n    cell_type_col=\"Cell_Type\",\n    st_coord_key=\"spatial_rir\",\n    sm_coord_key=\"SM_spatial_rir\",\n    cell_dot_size=250,\n    gene_dot_size=10,\n    x_min=x_min, x_max=x_max, \n    y_min=y_min, y_max=y_max,\n    figsize=(4, 4),\n    st_cmap='Accent',\n    g_cmap='Spectral_r',\n    m_cmap='plasma'\n)\n</code></pre> <pre>\n<code>[5373 3267] [ 42275 167991]\n</code>\n</pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:233: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.\n</code>\n</pre> <pre><code>%autoreload\npl.plot_gene_cell_type(st_adata, mdata, 'NCDN', 'Cell_Type', 'MSN')\n</code></pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:367: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:370: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\anndata\\_core\\anndata.py:1756: UserWarning: Observation names are not unique. To make them unique, call `.obs_names_make_unique`.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:375: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:376: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:377: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n</code>\n</pre> <pre><code>%autoreload\npl.plot_gene_cell_type(st_adata, mdata, 'PLP1', 'Cell_Type', 'Oligo')\n</code></pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:367: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\squidpy\\pl\\_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n</code>\n</pre> <pre>\n<code>c:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:370: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\n</code>\n</pre> <pre>\n<code>C:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\anndata\\_core\\anndata.py:1756: UserWarning: Observation names are not unique. To make them unique, call `.obs_names_make_unique`.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:375: FutureWarning: ChainedAssignmentError: behaviour will change in pandas 3.0!\nYou are setting values through chained assignment. Currently this works in certain cases, but when using Copy-on-Write (which will become the default behaviour in pandas 3.0) this will never work to update the original DataFrame or Series, because the intermediate object on which we are setting values will behave as a copy.\nA typical example is when you are setting values in a column of a DataFrame, like:\n\ndf[\"col\"][row_indexer] = value\n\nUse `df.loc[row_indexer, \"col\"] = values` instead, to perform the assignment in a single step and ensure this keeps updating the original `df`.\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:376: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\nC:\\Users\\User\\AppData\\Roaming\\Python\\Python312\\site-packages\\scipy\\sparse\\_index.py:151: SparseEfficiencyWarning: Changing the sparsity structure of a csr_matrix is expensive. lil_matrix is more efficient.\nc:\\Users\\User\\Dropbox\\workspace\\1_SMST\\SCRoFit\\docs\\tutorial\\../..\\scrofit\\plotting.py:377: ImplicitModificationWarning: Modifying `X` on a view results in data being overridden\n</code>\n</pre> <pre><code>bench_cor_df[bench_cor_df['gene'].isin(['GFAP', 'TF', 'NCDN', 'SCG2', 'MBP', 'PLP1'])]\n</code></pre> Region dopamine gene rho Pvalue Method Type InvLog10Pvalue Annotation Function Annotation 348 Cd Dopamine NCDN 0.244814 8.910519e-101 SMA Cd(SMA) 100.050097 Cd Region 2368 Cd Dopamine SCG2 0.326443 4.317302e-182 SMA Cd(SMA) 181.364788 Cd Region 3064 Cd Dopamine TF -0.234649 1.659563e-92 SMA Cd(SMA) 91.780006 Cd Region 11788 Cd Dopamine GFAP -0.262491 4.203159e-116 SMA Cd(SMA) 115.376424 Cd Region 12343 Cd Dopamine MBP -0.246967 1.403670e-102 SMA Cd(SMA) 101.852735 Cd Region 14624 Cd Dopamine PLP1 -0.233789 7.979968e-92 SMA Cd(SMA) 91.097999 Cd Region 0 Cd Dopamine NCDN 0.232060 1.737992e-94 SCRoFit Cd(SCRoFit) 93.759952 Cd Region 5 Cd Dopamine SCG2 0.192807 2.956723e-65 SCRoFit Cd(SCRoFit) 64.529189 Cd Region 7 Cd Dopamine TF -0.139372 1.220900e-34 SCRoFit Cd(SCRoFit) 33.913320 Cd Region 15 Cd Dopamine GFAP -0.125049 3.667300e-28 SCRoFit Cd(SCRoFit) 27.435654 Cd Region 16 Cd Dopamine MBP -0.178574 4.341583e-56 SCRoFit Cd(SCRoFit) 55.362352 Cd Region 20 Cd Dopamine PLP1 -0.151670 8.900975e-41 SCRoFit Cd(SCRoFit) 40.050562 Cd Region 21 CI Dopamine NCDN 0.040255 2.859989e-02 SCRoFit CI(SCRoFit) 1.543636 CI Region 26 CI Dopamine SCG2 0.129088 1.839477e-12 SCRoFit CI(SCRoFit) 11.735306 CI Region 28 CI Dopamine TF -0.503951 2.912170e-190 SCRoFit CI(SCRoFit) 189.535783 CI Region 36 CI Dopamine GFAP -0.453098 1.153272e-149 SCRoFit CI(SCRoFit) 148.938068 CI Region 37 CI Dopamine MBP -0.457587 5.602338e-153 SCRoFit CI(SCRoFit) 152.251631 CI Region 41 CI Dopamine PLP1 -0.475458 1.132699e-166 SCRoFit CI(SCRoFit) 165.945886 CI Region 42 ACB Dopamine NCDN 0.173216 1.763107e-12 SCRoFit ACB(SCRoFit) 11.753721 ACB Region 47 ACB Dopamine SCG2 0.133786 5.637002e-08 SCRoFit ACB(SCRoFit) 7.248952 ACB Region 49 ACB Dopamine TF -0.211509 5.436318e-18 SCRoFit ACB(SCRoFit) 17.264695 ACB Region 57 ACB Dopamine GFAP -0.558419 1.059766e-134 SCRoFit ACB(SCRoFit) 133.974790 ACB Region 58 ACB Dopamine MBP -0.292058 1.629507e-33 SCRoFit ACB(SCRoFit) 32.787944 ACB Region 62 ACB Dopamine PLP1 -0.144015 4.935206e-09 SCRoFit ACB(SCRoFit) 8.306695 ACB Region"},{"location":"tutorial/run_SCRoFit_Age/","title":"run SCRoFit Age","text":"<pre><code>%load_ext autoreload\n\nimport pickle as pk\n\npk.dump(obj_dict, open('../data/Aging_data/aging_scrofit_obj.pk', 'wb'))\npickle.load(open('../data/Aging_data/aging_scrofit_obj.pk', 'rb'))\n</code></pre> <pre>\n---------------------------------------------------------------------------\nNameError                                 Traceback (most recent call last)\nCell In[1], line 5\n      1 get_ipython().run_line_magic('load_ext', 'autoreload')\n      3 import pickle as pk\n----&gt; 5 pk.dump(obj_dict, open('../data/Aging_data/aging_scrofit_obj.pk', 'wb'))\n      6 pickle.load(open('../data/Aging_data/aging_scrofit_obj.pk', 'rb'))\n\nNameError: name 'obj_dict' is not defined</pre> <pre><code>%autoreload\nimport pandas as pd\nimport anndata as ad\nfrom src.scrofit import SCRoFit\n\nobj_dict = {}\nfor sample in ['Young1', 'Young2', 'Old1', 'Old2']:\n    print('-----', sample)\n    st_adata = ad.read_h5ad(f'../data/Aging_data/adata/{sample}_ST.adata')\n    sm_adata = ad.read_h5ad(f'../data/Aging_data/adata/{sample}_SC_SM.adata')\n    adata_dict = {'ST': st_adata, 'SM': sm_adata}\n\n    obj = SCRoFit(adata_dict)\n    obj.mapping(\n            mapping_method='MCMF', alpha=1, beta=1, k=3,\n            n_thread=6, n_batch=1000,\n            verbose=False)    \n    obj.check_slides(s=0.5)\n    obj_dict[sample] = obj\n</code></pre> <pre>\n<code>----- Young1\n</code>\n</pre> <pre>\n<code>---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 65092.77it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 976/976 [00:00&lt;00:00, 72264.52it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 984/984 [00:00&lt;00:00, 4067.50it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 1141455.72it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 80282.68it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 976/976 [00:00&lt;00:00, 159366.24it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1014/1014 [00:00&lt;00:00, 3672.89it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 1437878.72it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 99939.15it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 976/976 [00:00&lt;00:00, 60421.85it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1105/1105 [00:00&lt;00:00, 4133.29it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 1355510.17it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 82988.74it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 976/976 [00:00&lt;00:00, 84281.58it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1149/1149 [00:00&lt;00:00, 4509.35it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 986815.76it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 69713.01it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 976/976 [00:00&lt;00:00, 144162.58it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1133/1133 [00:00&lt;00:00, 4603.11it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 1085654.36it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 66524.32it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 976/976 [00:00&lt;00:00, 100992.76it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1205/1205 [00:00&lt;00:00, 2583.58it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 1092900.43it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 53614.67it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 976/976 [00:00&lt;00:00, 73234.12it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1247/1247 [00:00&lt;00:00, 4926.24it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 1124832.58it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 74524.68it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 976/976 [00:00&lt;00:00, 85421.21it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1400/1400 [00:00&lt;00:00, 4605.26it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2928/2928 [00:00&lt;00:00, 1047234.77it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2925/2925 [00:00&lt;00:00, 99992.98it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 975/975 [00:00&lt;00:00, 49650.90it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1329/1329 [00:00&lt;00:00, 5123.15it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2925/2925 [00:00&lt;00:00, 1092169.43it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2925/2925 [00:00&lt;00:00, 72201.95it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 975/975 [00:00&lt;00:00, 52286.69it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1450/1450 [00:00&lt;00:00, 5813.30it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2925/2925 [00:00&lt;00:00, 1133229.19it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2925/2925 [00:00&lt;00:00, 49184.71it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 975/975 [00:00&lt;00:00, 74171.51it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1641/1641 [00:00&lt;00:00, 6473.32it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2925/2925 [00:00&lt;00:00, 1136483.48it/s]\n-Solving MCMF Mapping by ILP with batch: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 11/11 [00:18&lt;00:00,  1.66s/it]\n</code>\n</pre> <pre>\n<code>Estimate raw_y_radius 15.009568416087, ccs_y_radius 15.009568116562935\n</code>\n</pre> <pre>\n<code>---Adjusting source position within target's range: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 3121/3121 [00:00&lt;00:00, 13390.19it/s]\nNo artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.\n</code>\n</pre> <pre>\n<code>----- Young2\n</code>\n</pre> <pre>\n<code>---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2919/2919 [00:00&lt;00:00, 74354.27it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 973/973 [00:00&lt;00:00, 66150.00it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 982/982 [00:00&lt;00:00, 3692.73it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2919/2919 [00:00&lt;00:00, 871338.22it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 91964.17it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 972/972 [00:00&lt;00:00, 75307.81it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1045/1045 [00:00&lt;00:00, 3911.85it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 620432.73it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 96364.56it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 972/972 [00:00&lt;00:00, 116438.57it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1142/1142 [00:00&lt;00:00, 4512.20it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 1193228.34it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 106946.28it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 972/972 [00:00&lt;00:00, 124850.35it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1147/1147 [00:00&lt;00:00, 4508.93it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 1265059.01it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 66167.45it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 972/972 [00:00&lt;00:00, 104328.98it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1130/1130 [00:00&lt;00:00, 4149.23it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 1059935.04it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 51962.81it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 972/972 [00:00&lt;00:00, 139733.46it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1195/1195 [00:00&lt;00:00, 5389.44it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 1196145.77it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 90266.66it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 972/972 [00:00&lt;00:00, 46042.84it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1273/1273 [00:00&lt;00:00, 5473.01it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 1136038.50it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 134278.14it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 972/972 [00:00&lt;00:00, 145706.34it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1349/1349 [00:00&lt;00:00, 5160.85it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 1050738.01it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 69693.55it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 972/972 [00:00&lt;00:00, 60489.38it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1358/1358 [00:00&lt;00:00, 4949.43it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 1322511.94it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 56482.94it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 972/972 [00:00&lt;00:00, 66234.46it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1505/1505 [00:00&lt;00:00, 2460.69it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 1294790.44it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 63814.33it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 972/972 [00:00&lt;00:00, 46809.39it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1683/1683 [00:00&lt;00:00, 6937.23it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2916/2916 [00:00&lt;00:00, 1116031.61it/s]\n-Solving MCMF Mapping by ILP with batch: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 11/11 [00:17&lt;00:00,  1.61s/it]\n</code>\n</pre> <pre>\n<code>Estimate raw_y_radius 10.95877605400573, ccs_y_radius 10.917882859968815\n</code>\n</pre> <pre>\n<code>---Adjusting source position within target's range: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 3697/3697 [00:00&lt;00:00, 12273.72it/s]\nNo artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.\n</code>\n</pre> <pre>\n<code>----- Old1\n</code>\n</pre> <pre>\n<code>---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2940/2940 [00:00&lt;00:00, 76674.03it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 980/980 [00:00&lt;00:00, 149301.44it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 962/962 [00:00&lt;00:00, 3456.25it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2940/2940 [00:00&lt;00:00, 1241443.04it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2940/2940 [00:00&lt;00:00, 77643.93it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 980/980 [00:00&lt;00:00, 59770.51it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1003/1003 [00:00&lt;00:00, 4147.02it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2940/2940 [00:00&lt;00:00, 1295708.08it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2940/2940 [00:00&lt;00:00, 52332.68it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 980/980 [00:00&lt;00:00, 88375.18it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1056/1056 [00:00&lt;00:00, 3767.42it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2940/2940 [00:00&lt;00:00, 1408803.13it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2940/2940 [00:00&lt;00:00, 76638.29it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 980/980 [00:00&lt;00:00, 110712.36it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1124/1124 [00:00&lt;00:00, 4469.58it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2940/2940 [00:00&lt;00:00, 1403351.97it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2940/2940 [00:00&lt;00:00, 62040.92it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 980/980 [00:00&lt;00:00, 178667.21it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1137/1137 [00:00&lt;00:00, 4875.18it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2940/2940 [00:00&lt;00:00, 876795.63it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2937/2937 [00:00&lt;00:00, 83859.24it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 979/979 [00:00&lt;00:00, 74289.86it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1179/1179 [00:00&lt;00:00, 2884.93it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2937/2937 [00:00&lt;00:00, 1283729.77it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2937/2937 [00:00&lt;00:00, 100737.38it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 979/979 [00:00&lt;00:00, 197064.05it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1275/1275 [00:00&lt;00:00, 3611.16it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2937/2937 [00:00&lt;00:00, 1128807.01it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2937/2937 [00:00&lt;00:00, 97219.41it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 979/979 [00:00&lt;00:00, 98087.18it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1361/1361 [00:00&lt;00:00, 5607.71it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2937/2937 [00:00&lt;00:00, 1569057.55it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2937/2937 [00:00&lt;00:00, 84532.52it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 979/979 [00:00&lt;00:00, 139972.17it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1337/1337 [00:00&lt;00:00, 4780.33it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2937/2937 [00:00&lt;00:00, 1112496.24it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2937/2937 [00:00&lt;00:00, 80898.59it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 979/979 [00:00&lt;00:00, 192789.50it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1447/1447 [00:00&lt;00:00, 5899.83it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2937/2937 [00:00&lt;00:00, 1323449.81it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2937/2937 [00:00&lt;00:00, 120949.15it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 979/979 [00:00&lt;00:00, 89749.60it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1670/1670 [00:00&lt;00:00, 6789.91it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2937/2937 [00:00&lt;00:00, 954861.70it/s]\n-Solving MCMF Mapping by ILP with batch: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 11/11 [00:21&lt;00:00,  1.99s/it]\n</code>\n</pre> <pre>\n<code>Estimate raw_y_radius 14.79016400000614, ccs_y_radius 14.790163999998269\n</code>\n</pre> <pre>\n<code>---Adjusting source position within target's range: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 3021/3021 [00:00&lt;00:00, 12954.55it/s]\nNo artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.\n</code>\n</pre> <pre>\n<code>----- Old2\n</code>\n</pre> <pre>\n<code>---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2787/2787 [00:00&lt;00:00, 177773.94it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 929/929 [00:00&lt;00:00, 73369.52it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 935/935 [00:00&lt;00:00, 3315.29it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2787/2787 [00:00&lt;00:00, 1373783.67it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 49403.63it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 928/928 [00:00&lt;00:00, 64266.72it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 953/953 [00:00&lt;00:00, 2324.87it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 1404660.45it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 167104.70it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 928/928 [00:00&lt;00:00, 169525.88it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1042/1042 [00:00&lt;00:00, 3616.02it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 1539072.40it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 73887.86it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 928/928 [00:00&lt;00:00, 45885.86it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1037/1037 [00:00&lt;00:00, 4318.91it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 1080698.04it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 94764.99it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 928/928 [00:00&lt;00:00, 57629.76it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1077/1077 [00:00&lt;00:00, 3588.38it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 1120735.42it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 154094.10it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 928/928 [00:00&lt;00:00, 100023.49it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1123/1123 [00:00&lt;00:00, 4329.28it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 1105561.67it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 97827.97it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 928/928 [00:00&lt;00:00, 58508.16it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1167/1167 [00:00&lt;00:00, 4401.91it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 1524007.09it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 196654.36it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 928/928 [00:00&lt;00:00, 186986.65it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1228/1228 [00:00&lt;00:00, 4377.18it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 1137216.82it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 124103.97it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 928/928 [00:00&lt;00:00, 47608.91it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1305/1305 [00:00&lt;00:00, 5485.48it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 1133133.66it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 79707.18it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 928/928 [00:00&lt;00:00, 59556.49it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1301/1301 [00:00&lt;00:00, 3961.37it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 1115915.74it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 79189.87it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 928/928 [00:00&lt;00:00, 56975.15it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1422/1422 [00:00&lt;00:00, 5335.22it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 1170738.15it/s]\n---Adding spatial constraints (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 55578.02it/s]\n---Adding capacity constraints (unit: source): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 928/928 [00:00&lt;00:00, 66290.52it/s]\n---Adding functional constraints (unit: occupied target): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1629/1629 [00:00&lt;00:00, 7388.99it/s]\n/Users/chenlingxi/miniconda3/envs/cospa/lib/python3.11/site-packages/pulp/pulp.py:1650: UserWarning: Overwriting previously set objective.\n  warnings.warn(\"Overwriting previously set objective.\")\n---Get the flow edge (unit: flow edge): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2784/2784 [00:00&lt;00:00, 1180204.40it/s]\n-Solving MCMF Mapping by ILP with batch: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 12/12 [00:18&lt;00:00,  1.53s/it]\n</code>\n</pre> <pre>\n<code>Estimate raw_y_radius 14.875175750018737, ccs_y_radius 14.875176010112925\n</code>\n</pre> <pre>\n<code>---Adjusting source position within target's range: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 3072/3072 [00:00&lt;00:00, 13476.00it/s]\nNo artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.\n</code>\n</pre> <pre><code>for sample in ['Young1', 'Young2', 'Old1', 'Old2']:\n    obj = obj_dict[sample]\n    sm_adata = obj.adata_dict['SM']\n    st_adata = obj.adata_dict['ST']\n    df = st_adata[sm_adata.obsm['mappingflow_MCMF'].nonzero()[1]].obs\n    df = df[['Region', 'Region_2', 'Region_3', 'spotID', 'hires_x', 'hires_y', 'CellType']]\n    df = df.reset_index()\n    sm_df = sm_adata.obs[['run', 'pixel', 'x', 'y', 'align_x', 'align_y']]\n    sm_df[['spatial_MCMF_map_x', 'spatial_MCMF_map_y']] = sm_adata.obsm['spatial_MCMF_map']\n    sm_df = sm_df.reset_index()\n    df = pd.concat([sm_df, df], axis=1)\n    df.to_csv(f'../data/Aging_data/{sample}_SM_meta_SCRoFit.csv')\n</code></pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_48225/3830015420.py:9: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  sm_df[['spatial_MCMF_map_x', 'spatial_MCMF_map_y']] = sm_adata.obsm['spatial_MCMF_map']\n/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_48225/3830015420.py:9: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  sm_df[['spatial_MCMF_map_x', 'spatial_MCMF_map_y']] = sm_adata.obsm['spatial_MCMF_map']\n/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_48225/3830015420.py:9: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  sm_df[['spatial_MCMF_map_x', 'spatial_MCMF_map_y']] = sm_adata.obsm['spatial_MCMF_map']\n/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_48225/3830015420.py:9: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  sm_df[['spatial_MCMF_map_x', 'spatial_MCMF_map_y']] = sm_adata.obsm['spatial_MCMF_map']\n/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_48225/3830015420.py:9: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  sm_df[['spatial_MCMF_map_x', 'spatial_MCMF_map_y']] = sm_adata.obsm['spatial_MCMF_map']\n/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_48225/3830015420.py:9: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  sm_df[['spatial_MCMF_map_x', 'spatial_MCMF_map_y']] = sm_adata.obsm['spatial_MCMF_map']\n/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_48225/3830015420.py:9: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  sm_df[['spatial_MCMF_map_x', 'spatial_MCMF_map_y']] = sm_adata.obsm['spatial_MCMF_map']\n/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_48225/3830015420.py:9: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  sm_df[['spatial_MCMF_map_x', 'spatial_MCMF_map_y']] = sm_adata.obsm['spatial_MCMF_map']\n</code>\n</pre> <pre><code>\n</code></pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_48225/3515338631.py:5: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  sm_df[['spatial_MCMF_map_x', 'spatial_MCMF_map_y']] = sm_adata.obsm['spatial_MCMF_map']\n/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_48225/3515338631.py:5: SettingWithCopyWarning: \nA value is trying to be set on a copy of a slice from a DataFrame.\nTry using .loc[row_indexer,col_indexer] = value instead\n\nSee the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy\n  sm_df[['spatial_MCMF_map_x', 'spatial_MCMF_map_y']] = sm_adata.obsm['spatial_MCMF_map']\n</code>\n</pre> index run pixel x y align_x align_y spatial_MCMF_map_x spatial_MCMF_map_y index Region Region_2 Region_3 spotID hires_x hires_y CellType 0 Old2_pixel3381 m24115318a pixel3381 54 35 474.759226 1262.874945 1269.229418 470.072187 Old2_AACACTTGGCAAGGAA-1 Brain stem MB MRN AACACTTGGCAAGGAA-1 1267.007939 472.141851 eAstrocytes;pAstrocytes;tAstrocytes 1 Old2_pixel3264 m24115318a pixel3264 54 34 460.194791 1263.893389 1256.867957 470.936584 Old2_AACACTTGGCAAGGAA-1 Brain stem MB MRN AACACTTGGCAAGGAA-1 1267.007939 472.141851 eAstrocytes;pAstrocytes;tAstrocytes 2 Old2_pixel3380 m24115318a pixel3380 53 35 475.777670 1277.439380 1270.093816 482.433648 Old2_AACACTTGGCAAGGAA-1 Brain stem MB MRN AACACTTGGCAAGGAA-1 1267.007939 472.141851 eAstrocytes;pAstrocytes;tAstrocytes 3 Old2_pixel3382 m24115318a pixel3382 55 35 473.740781 1248.310510 1268.365020 457.710726 Old2_AACACTTGGCAAGGAA-1 Brain stem MB MRN AACACTTGGCAAGGAA-1 1267.007939 472.141851 eAstrocytes;pAstrocytes;tAstrocytes 4 Old2_pixel3263 m24115318a pixel3263 53 34 461.213235 1278.457824 1257.732354 483.298045 Old2_AACACTTGGCAAGGAA-1 Brain stem MB MRN AACACTTGGCAAGGAA-1 1267.007939 472.141851 eAstrocytes;pAstrocytes;tAstrocytes ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... ... 11132 Old2_pixel1295 m24115318a pixel1295 137 16 113.504063 73.377274 65.207411 104.429032 Old2_GCAGGCCAACATCGCT-1 Cerebrum Isocortex VIS_L2/L3/L4 GCAGGCCAACATCGCT-1 54.826026 93.775503 Neuro_3 11133 Old2_pixel6029 m24115318a pixel6029 113 57 735.088572 381.167492 387.733427 730.217127 Old2_TGTTGGATGGACTTCT-1 Fiber tracts Fiber tracts Fiber tracts TGTTGGATGGACTTCT-1 386.898138 734.253284 Neuro_6 11134 Old2_pixel6028 m24115318a pixel6028 112 57 736.107017 395.731928 388.751871 744.781562 Old2_TGTTGGATGGACTTCT-1 Fiber tracts Fiber tracts Fiber tracts TGTTGGATGGACTTCT-1 386.898138 734.253284 Neuro_6 11135 Old2_pixel6208 m24115318a pixel6208 49 59 829.397892 1311.254452 1316.927091 826.486157 Old2_TGTTGGCCAGACCTAC-1 Brain stem MB PRT TGTTGGCCAGACCTAC-1 1316.566512 828.844871 Neuro_5;Neuro_1 11136 Old2_pixel6207 m24115318a pixel6207 48 59 830.416336 1325.818887 1317.591133 835.982401 Old2_TGTTGGCCAGACCTAC-1 Brain stem MB PRT TGTTGGCCAGACCTAC-1 1316.566512 828.844871 Neuro_5;Neuro_1 <p>11137 rows \u00d7 17 columns</p> <pre><code>df\n</code></pre> Region Region_2 Region_3 spotID hires_x hires_y CellType n_genes Old2_AACACTTGGCAAGGAA-1 Brain stem MB MRN AACACTTGGCAAGGAA-1 1267.007939 472.141851 eAstrocytes;pAstrocytes;tAstrocytes 6751 Old2_AACACTTGGCAAGGAA-1 Brain stem MB MRN AACACTTGGCAAGGAA-1 1267.007939 472.141851 eAstrocytes;pAstrocytes;tAstrocytes 6751 Old2_AACACTTGGCAAGGAA-1 Brain stem MB MRN AACACTTGGCAAGGAA-1 1267.007939 472.141851 eAstrocytes;pAstrocytes;tAstrocytes 6751 Old2_AACACTTGGCAAGGAA-1 Brain stem MB MRN AACACTTGGCAAGGAA-1 1267.007939 472.141851 eAstrocytes;pAstrocytes;tAstrocytes 6751 Old2_AACACTTGGCAAGGAA-1 Brain stem MB MRN AACACTTGGCAAGGAA-1 1267.007939 472.141851 eAstrocytes;pAstrocytes;tAstrocytes 6751 ... ... ... ... ... ... ... ... ... Old2_GCAGGCCAACATCGCT-1 Cerebrum Isocortex VIS_L2/L3/L4 GCAGGCCAACATCGCT-1 54.826026 93.775503 Neuro_3 7311 Old2_TGTTGGATGGACTTCT-1 Fiber tracts Fiber tracts Fiber tracts TGTTGGATGGACTTCT-1 386.898138 734.253284 Neuro_6 6602 Old2_TGTTGGATGGACTTCT-1 Fiber tracts Fiber tracts Fiber tracts TGTTGGATGGACTTCT-1 386.898138 734.253284 Neuro_6 6602 Old2_TGTTGGCCAGACCTAC-1 Brain stem MB PRT TGTTGGCCAGACCTAC-1 1316.566512 828.844871 Neuro_5;Neuro_1 7649 Old2_TGTTGGCCAGACCTAC-1 Brain stem MB PRT TGTTGGCCAGACCTAC-1 1316.566512 828.844871 Neuro_5;Neuro_1 7649 <p>11137 rows \u00d7 8 columns</p>"},{"location":"tutorial/run_SCRoFit_SMA%20copy/","title":"run SCRoFit SMA copy","text":"<pre><code>%autoreload\n\nimport anndata as ad\nimport os\nimport pandas as pd\n\nimport sys\nsys.path.append('../../')\n\nfrom scrofit.scrofit import SCRoFit\n\ndf = pd.read_csv('../../../data/MSA_data/corHstr_onlyCdSpots.csv', index_col=0)\nSMA_cor_df = df[(df['FDR'] &amp;lt; 0.05) &amp;amp; (df['rho'].abs() &amp;gt; 0.2)]\n\n\ndef run_align(in_dir, sample):\n\n    st_adata = ad.read_h5ad(f'{in_dir}/{sample}_st_raw.adata')\n    sm_adata = ad.read_h5ad(f'{in_dir}/{sample}_sm_raw.adata')\n    adata_dict = {'ST': st_adata, 'SM': sm_adata}\n\n    out_dir = os.path.join(in_dir, 'scrofit_out')\n\n    obj = SCRoFit(adata_dict=adata_dict, out_dir=out_dir, sample=sample)\n\n    obj.align_slides()\n\n    print('---start mapping---')\n    obj.mapping(mapping_method='MCMF', ccs_type='spatial_rir',\n                alpha=1, beta=1, n_neighbors=3,\n                n_thread=6, n_batch=250,\n                verbose=False)  \n\n    obj.check_slides()\n\n    headers = ['RegionLoupe', 'MSN.D2.PenkPos_2', 'MSN.D1.TacNeg_3', 'MSN.D2.PenkNeg_5',\n               'MSN.D1.TacPosB_6', 'MSN.D1.TacPosA_9', 'MSN.D2_C_18'] + SMA_cor_df['gene'].tolist()\n    obj.transfer_anno(headers)\n\n    for key, adata in adata_dict.items():\n        fn = '{}/{}_{}_pp.adata'.format(in_dir, sample, key.lower())\n        adata.write_h5ad(fn)\n\n    return obj, adata_dict\n\nobj_dict = {}\nfor sample in ['V11T17-102']:\n    for block in ['A1', 'B1', 'C1', 'D1']:\n        print(block)\n        in_dir = f'../../../data/MSA_data/{sample}'\n        obj, adata_dict = run_align(in_dir, sample + '_' + block)\n        obj_dict[block] = obj\n</code></pre> <pre><code>%autoreload\n\nimport anndata as ad\nimport os\nimport numpy as np\nfrom scrofit.mapping import init_mdata\n\ndef replace_y_coord(in_dir, sample, block, i):\n    st_adata = ad.read_h5ad(f'{in_dir}/{sample}_{block}_st_pp.adata')\n    sm_adata = ad.read_h5ad(f'{in_dir}/{sample}_{block}_sm_pp.adata')\n\n    for key in  ['spatial_rir_filtered', 'spatial_MCMF_map', 'spatial']:\n        if key in st_adata.obsm:\n            st_adata.obsm[key][:, 1] += 45000*i\n            print(sample, key, 'ST', st_adata.obsm[key][:, 1].min(), st_adata.obsm[key][:, 1].max())\n        if key in sm_adata.obsm:\n            if key == 'spatial':\n                sm_adata.obsm[key][:, 1] += 70*i\n            else:\n                sm_adata.obsm[key][:, 1] += 45000*i\n            print(sample, key, 'ST', sm_adata.obsm[key][:, 1].min(), sm_adata.obsm[key][:, 1].max())\n\n    return st_adata, sm_adata\n\nst_adata_list, sm_adata_list = [], []\nmdata_list = []\nfor sample in ['V11T17-102']:\n    image_list = []\n    for i, block in enumerate(['A1', 'B1', 'C1', 'D1']):\n        in_dir = f'../../../data/MSA_data/{sample}'\n        st_adata, sm_adata = replace_y_coord(in_dir, sample, block, i)\n        st_adata_list.append(st_adata)\n        sm_adata_list.append(sm_adata)\n\n        image = st_adata.uns['spatial'][f'{sample}_{block}']['images']['hires']\n        scalefactors = st_adata.uns['spatial'][f'{sample}_{block}']['scalefactors']\n\n        image_list.append(image)\n\n        #for col in sm_adata.obs.columns:\n        #    if col.startswith('ST'):\n        #        del sm_adata.obs[col]\n        mdata = init_mdata(sm_adata, st_adata)  \n        mdata_list.append(mdata)\n\n\n    st_adata = ad.concat(st_adata_list)\n    print(st_adata_list[0].uns['spatial'][f'{sample}_A1']['scalefactors'])\n    print(st_adata_list[1].uns['spatial'][f'{sample}_B1']['scalefactors'])\n    print(st_adata_list[2].uns['spatial'][f'{sample}_C1']['scalefactors'])\n    print(st_adata_list[3].uns['spatial'][f'{sample}_D1']['scalefactors'])    \n    st_adata.uns['spatial'] = {sample:{\n        'images': {'hires': np.concatenate(image_list)},\n        'scalefactors': scalefactors\n        }}\n\n    sm_adata = ad.concat(sm_adata_list)\n    sm_adata.uns['spatial'] = {sample:{'images': {'hires': np.concatenate(image_list)}}}\n\n    mdata = ad.concat(mdata_list)\n\n\n    st_adata.write_h5ad(f'{in_dir}/{sample}_st_pp.adata')\n    sm_adata.write_h5ad(f'{in_dir}/{sample}_sm_pp.adata')\n    mdata.write_h5ad(f'{in_dir}/{sample}_m_pp.adata')\n</code></pre> <pre>\n<code>V11T17-102 spatial_rir_filtered ST 3267 41826\nV11T17-102 spatial_rir_filtered ST nan nan\nV11T17-102 spatial_MCMF_map ST nan nan\nV11T17-102 spatial ST 3267 41826\nV11T17-102 spatial ST 0 64\nV11T17-102 spatial_rir_filtered ST 47834 86785\nV11T17-102 spatial_rir_filtered ST nan nan\nV11T17-102 spatial_MCMF_map ST nan nan\nV11T17-102 spatial ST 47834 86785\nV11T17-102 spatial ST 70 134\nV11T17-102 spatial_rir_filtered ST 92762 131250\nV11T17-102 spatial_rir_filtered ST nan nan\nV11T17-102 spatial_MCMF_map ST nan nan\nV11T17-102 spatial ST 92762 131250\nV11T17-102 spatial ST 140 204\nV11T17-102 spatial_rir_filtered ST 137673 176669\nV11T17-102 spatial_rir_filtered ST nan nan\nV11T17-102 spatial_MCMF_map ST nan nan\nV11T17-102 spatial ST 137673 176669\nV11T17-102 spatial ST 210 275\n{'fiducial_diameter_fullres': np.float64(610.9539999999998), 'spot_diameter_fullres': np.float64(378.20962999999995), 'tissue_hires_scalef': np.float64(0.04111842), 'tissue_lowres_scalef': np.float64(0.012335527)}\n{'fiducial_diameter_fullres': np.float64(609.50275), 'spot_diameter_fullres': np.float64(377.31122), 'tissue_hires_scalef': np.float64(0.04111842), 'tissue_lowres_scalef': np.float64(0.012335527)}\n{'fiducial_diameter_fullres': np.float64(609.6982399999999), 'spot_diameter_fullres': np.float64(377.43224999999995), 'tissue_hires_scalef': np.float64(0.04111842), 'tissue_lowres_scalef': np.float64(0.012335527)}\n{'fiducial_diameter_fullres': np.float64(609.4973), 'spot_diameter_fullres': np.float64(377.30785999999995), 'tissue_hires_scalef': np.float64(0.04111842), 'tissue_lowres_scalef': np.float64(0.012335527)}\n</code>\n</pre> <pre>\n<code>/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/anndata/_core/aligned_df.py:68: ImplicitModificationWarning: Transforming to str index.\n  warnings.warn(\"Transforming to str index.\", ImplicitModificationWarning)\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/anndata/_core/anndata.py:1756: UserWarning: Observation names are not unique. To make them unique, call `.obs_names_make_unique`.\n  utils.warn_names_duplicates(\"obs\")\n</code>\n</pre> <pre><code>%autoreload\nfrom scrofit.embedding import embedding\n\nsm_adata.obsm['After SCRoFit\\nST OCS'] = sm_adata.obsm['spatial_MCMF_map']\nsm_adata.obsm['SMA\\nSM OCS'] = sm_adata.obsm['spatial']\nst_adata.obsm['SMA\\nST OCS'] = st_adata.obsm['spatial']\nsc.pl.spatial(st_adata, basis='SMA\\nST OCS')\nimport squidpy as sq\n\nmymap = {'unk': np.nan, 'unk2': np.nan}\nst_adata.obs['Region'] = st_adata.obs['RegionLoupe'].apply(lambda x: mymap.get(x, x))\nsq.pl.spatial_scatter(st_adata, color=['Region'], img=True, shape=None, library_id=sample,\n                      spatial_key='SMA\\nST OCS', size=0.5)\nsq.pl.spatial_scatter(st_adata, color=['dopamine'], img=True, shape=None, library_id=sample,\n                      spatial_key='SMA\\nST OCS', size=0.5, cmap='Set2')\n</code></pre> <pre>\n<code>/var/folders/0x/6vsm66sd6g3_gc636v4617km0000gn/T/ipykernel_29340/1445981774.py:7: FutureWarning: Use `squidpy.pl.spatial_scatter` instead.\n  sc.pl.spatial(st_adata, basis='SMA\\nST OCS')\n</code>\n</pre> <pre>\n<code>/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/squidpy/pl/_spatial_utils.py:976: UserWarning: No data for colormapping provided via 'c'. Parameters 'cmap', 'norm' will be ignored\n  _cax = scatter(\n</code>\n</pre> <pre><code>mdata\n</code></pre> <pre>\n<code>AnnData object with n_obs \u00d7 n_vars = 15813 \u00d7 13934\n    obs: 'SM_index', 'SM_sample', 'SM_block', 'SM_n_genes', 'SM_ST_RegionLoupe', 'SM_ST_MSN.D2.PenkNeg_5', 'SM_ST_MSN.D1.TacNeg_3', 'SM_ST_MSN.D2_C_18', 'SM_ST_MSN.D1.TacPosB_6', 'SM_ST_MSN.D1.TacPosA_9', 'SM_ST_MSN.D2.PenkPos_2', 'SM_ST_ST_id', 'SM_LY6H', 'SM_THY1', 'SM_VSNL1', 'SM_PCDH11X', 'SM_MBP', 'SM_PLP1', 'SM_CHN1', 'SM_SYNPR', 'SM_NCDN', 'SM_MAP2', 'SM_GDA', 'SM_HPCAL4', 'SM_RTN1', 'SM_NNAT', 'SM_TSPAN7', 'SM_PEG10', 'SM_SCG2', 'SM_TF', 'SM_CRYM', 'SM_GFAP', 'SM_MT1G', 'ST_index', 'ST_in_tissue', 'ST_array_row', 'ST_array_col', 'ST_dopamine', 'ST_cell_type', 'ST_sample', 'ST_block', 'ST_orig.ident', 'ST_nCount_RNA', 'ST_nFeature_RNA', 'ST_Protocol', 'ST_Path.To.File', 'ST_File.Name', 'ST_Data.Type', 'ST_Glass.Type', 'ST_ArrayID', 'ST_Sample.ID', 'ST_Matrix', 'ST_Laser', 'ST_Laser.resolution', 'ST_Condition', 'ST_Brain.area', 'ST_Visium.Protocol', 'ST_id', 'ST_labels', 'ST_Prot.Short', 'ST_section_number', 'ST_type', 'ST_type.area', 'ST_lesion', 'ST_region', 'ST_RegionLoupe', 'ST_percent.mito', 'ST_percent.ribo', 'ST_Astrocytes', 'ST_Cerebellum.neurons', 'ST_Cholinergic.and.monoaminergic.neurons', 'ST_Cholinergic.and.monoaminergic.neurons.MBDOP1', 'ST_Cholinergic.and.monoaminergic.neurons.MBDOP2', 'ST_Choroid.epithelial.cells', 'ST_Dentate.gyrus.granule.neurons', 'ST_Dentate.gyrus.radial.glia.like.cells', 'ST_Di..and.mesencephalon.excitatory.neurons', 'ST_Di..and.mesencephalon.inhibitory.neurons', 'ST_Enteric.glia', 'ST_Enteric.neurons', 'ST_Ependymal.cells', 'ST_Glutamatergic.neuroblasts', 'ST_Hindbrain.neurons', 'ST_Microglia', 'ST_Non.glutamatergic.neuroblasts', 'ST_Olfactory.ensheathing.cells', 'ST_Olfactory.inhibitory.neurons', 'ST_Olfactory.inhibitory.neurons.OBDOP1', 'ST_Olfactory.inhibitory.neurons.OBDOP2', 'ST_Oligodendrocyte.precursor.cells', 'ST_Oligodendrocytes', 'ST_Peptidergic.neurons', 'ST_Pericytes', 'ST_Peripheral.sensory.neurofilament.neurons', 'ST_Peripheral.sensory.non.peptidergic.neurons', 'ST_Peripheral.sensory.peptidergic.neurons', 'ST_Perivascular.macrophages', 'ST_Satellite.glia', 'ST_Schwann.cells', 'ST_Spinal.cord.excitatory.neurons', 'ST_Spinal.cord.inhibitory.neurons', 'ST_Subcommissural.organ.hypendymal.cells', 'ST_Subventricular.zone.radial.glia.like.cells', 'ST_Sympathetic.cholinergic.neurons', 'ST_Sympathetic.noradrenergic.neurons', 'ST_Telencephalon.inhibitory.interneurons', 'ST_Telencephalon.projecting.excitatory.neurons', 'ST_Telencephalon.projecting.inhibitory.neurons.MSN1', 'ST_Telencephalon.projecting.inhibitory.neurons.MSN2', 'ST_Telencephalon.projecting.inhibitory.neurons.MSN3', 'ST_Telencephalon.projecting.inhibitory.neurons.MSN4', 'ST_Telencephalon.projecting.inhibitory.neurons.MSN5', 'ST_Telencephalon.projecting.inhibitory.neurons.MSN6', 'ST_Vascular.and.leptomeningeal.cells', 'ST_Vascular.endothelial.cells', 'ST_Vascular.smooth.muscle.cells', 'ST_nCount_SCT', 'ST_nFeature_SCT', 'ST_Astro_0', 'ST_Oligo_1', 'ST_MSN.D2.PenkPos_2', 'ST_MSN.D1.TacNeg_3', 'ST_Oligo_4', 'ST_MSN.D2.PenkNeg_5', 'ST_MSN.D1.TacPosB_6', 'ST_OPC_7', 'ST_Mi.MiR.Ma_8', 'ST_MSN.D1.TacPosA_9', 'ST_Astro_10', 'ST_Astro_11', 'ST_Inhib_MSN_12', 'ST_Inhib_13', 'ST_unk_14', 'ST_unk_15', 'ST_unk_16', 'ST_Astro_17', 'ST_MSN.D2_C_18', 'ST_unk_19', 'ST_OPC_20', 'ST_Oligo_21', 'ST_unk_22', 'ST_barcode', 'ST_library', 'ST_n_genes', 'SM_i', 'ST_i'\n    obsm: 'SM_XY_spatial_euclidean_dist', 'SM_mappingflow_MCMF', 'SM_spatial', 'SM_spatial_MCMF_map', 'SM_spatial_normalized', 'SM_spatial_rir', 'SM_spatial_rir_filtered', 'ST_spatial', 'ST_spatial_normalized', 'ST_spatial_rir', 'ST_spatial_rir_filtered'\n    layers: 'log1p', 'raw'</code>\n</pre> <pre><code>%autoreload\nfrom scrofit.embedding import embedding\n\n\nembedding(mdata)\n</code></pre> <pre>\n<code>/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/scanpy/tools/_utils.py:40: UserWarning: You\u2019re trying to run this on 13934 dimensions of `.X`, if you really want this, set `use_rep='X'`.\n         Falling back to preprocessing with `sc.pp.pca` and default params.\n  warnings.warn(\n</code>\n</pre> <pre>\n---------------------------------------------------------------------------\nKeyError                                  Traceback (most recent call last)\nCell In[166], line 5\n      1 get_ipython().run_line_magic('autoreload', '')\n      2 from scrofit.embedding import embedding\n----&gt; 5 embedding(mdata)\n\nFile &lt;string&gt;:4, in embedding(mdata, source_key, target_key, mapping_method, layer)\n\nFile ~/miniconda3/envs/dev/lib/python3.11/site-packages/scanpy/plotting/_tools/scatterplots.py:686, in umap(adata, **kwargs)\n    627 @_wraps_plot_scatter\n    628 @_doc_params(\n    629     adata_color_etc=doc_adata_color_etc,\n   (...)    633 )\n    634 def umap(adata: AnnData, **kwargs) -&gt; Figure | Axes | list[Axes] | None:\n    635     \"\"\"Scatter plot in UMAP basis.\n    636 \n    637     Parameters\n   (...)    684 \n    685     \"\"\"\n--&gt; 686     return embedding(adata, \"umap\", **kwargs)\n\nFile ~/miniconda3/envs/dev/lib/python3.11/site-packages/scanpy/plotting/_tools/scatterplots.py:279, in embedding(adata, basis, color, mask_obs, gene_symbols, use_raw, sort_order, edges, edges_width, edges_color, neighbors_key, arrows, arrows_kwds, groups, components, dimensions, layer, projection, scale_factor, color_map, cmap, palette, na_color, na_in_legend, size, frameon, legend_fontsize, legend_fontweight, legend_loc, legend_fontoutline, colorbar_loc, vmax, vmin, vcenter, norm, add_outline, outline_width, outline_color, ncols, hspace, wspace, title, show, save, ax, return_fig, marker, **kwargs)\n    277 for count, (value_to_plot, dims) in enumerate(zip(color, dimensions)):\n    278     kwargs_scatter = kwargs.copy()  # is potentially mutated for each plot\n--&gt; 279     color_source_vector = _get_color_source_vector(\n    280         adata,\n    281         value_to_plot,\n    282         layer=layer,\n    283         mask_obs=mask_obs,\n    284         use_raw=use_raw,\n    285         gene_symbols=gene_symbols,\n    286         groups=groups,\n    287     )\n    288     color_vector, color_type = _color_vector(\n    289         adata,\n    290         value_to_plot,\n   (...)    293         na_color=na_color,\n    294     )\n    296     # Order points\n\nFile ~/miniconda3/envs/dev/lib/python3.11/site-packages/scanpy/plotting/_tools/scatterplots.py:1200, in _get_color_source_vector(adata, value_to_plot, mask_obs, use_raw, gene_symbols, layer, groups)\n   1198     values = adata.raw.obs_vector(value_to_plot)\n   1199 else:\n-&gt; 1200     values = adata.obs_vector(value_to_plot, layer=layer)\n   1201 if mask_obs is not None:\n   1202     values[~mask_obs] = np.nan\n\nFile ~/miniconda3/envs/dev/lib/python3.11/site-packages/anndata/_core/anndata.py:1297, in AnnData.obs_vector(self, k, layer)\n   1291         warnings.warn(\n   1292             \"In a future version of AnnData, access to `.X` by passing\"\n   1293             \" `layer='X'` will be removed. Instead pass `layer=None`.\",\n   1294             FutureWarning,\n   1295         )\n   1296         layer = None\n-&gt; 1297 return get_vector(self, k, \"obs\", \"var\", layer=layer)\n\nFile ~/miniconda3/envs/dev/lib/python3.11/site-packages/anndata/_core/index.py:245, in get_vector(adata, k, coldim, idxdim, layer)\n    243 elif (in_col + in_idx) == 0:\n    244     msg = f\"Could not find key {k} in .{idxdim}_names or .{coldim}.columns.\"\n--&gt; 245     raise KeyError(msg)\n    246 elif in_col:\n    247     return getattr(adata, coldim)[k].values\n\nKeyError: 'Could not find key RegionLoupe in .var_names or .obs.columns.'</pre> <pre><code>for x in mdata.obs.columns:\n    print(x)\n</code></pre> <pre>\n<code>SM_index\nSM_sample\nSM_block\nSM_n_genes\nSM_ST_RegionLoupe\nSM_ST_MSN.D2.PenkNeg_5\nSM_ST_MSN.D1.TacNeg_3\nSM_ST_MSN.D2_C_18\nSM_ST_MSN.D1.TacPosB_6\nSM_ST_MSN.D1.TacPosA_9\nSM_ST_MSN.D2.PenkPos_2\nSM_ST_ST_id\nSM_LY6H\nSM_THY1\nSM_VSNL1\nSM_PCDH11X\nSM_MBP\nSM_PLP1\nSM_CHN1\nSM_SYNPR\nSM_NCDN\nSM_MAP2\nSM_GDA\nSM_HPCAL4\nSM_RTN1\nSM_NNAT\nSM_TSPAN7\nSM_PEG10\nSM_SCG2\nSM_TF\nSM_CRYM\nSM_GFAP\nSM_MT1G\nST_index\nST_in_tissue\nST_array_row\nST_array_col\nST_dopamine\nST_cell_type\nST_sample\nST_block\nST_orig.ident\nST_nCount_RNA\nST_nFeature_RNA\nST_Protocol\nST_Path.To.File\nST_File.Name\nST_Data.Type\nST_Glass.Type\nST_ArrayID\nST_Sample.ID\nST_Matrix\nST_Laser\nST_Laser.resolution\nST_Condition\nST_Brain.area\nST_Visium.Protocol\nST_id\nST_labels\nST_Prot.Short\nST_section_number\nST_type\nST_type.area\nST_lesion\nST_region\nST_RegionLoupe\nST_percent.mito\nST_percent.ribo\nST_Astrocytes\nST_Cerebellum.neurons\nST_Cholinergic.and.monoaminergic.neurons\nST_Cholinergic.and.monoaminergic.neurons.MBDOP1\nST_Cholinergic.and.monoaminergic.neurons.MBDOP2\nST_Choroid.epithelial.cells\nST_Dentate.gyrus.granule.neurons\nST_Dentate.gyrus.radial.glia.like.cells\nST_Di..and.mesencephalon.excitatory.neurons\nST_Di..and.mesencephalon.inhibitory.neurons\nST_Enteric.glia\nST_Enteric.neurons\nST_Ependymal.cells\nST_Glutamatergic.neuroblasts\nST_Hindbrain.neurons\nST_Microglia\nST_Non.glutamatergic.neuroblasts\nST_Olfactory.ensheathing.cells\nST_Olfactory.inhibitory.neurons\nST_Olfactory.inhibitory.neurons.OBDOP1\nST_Olfactory.inhibitory.neurons.OBDOP2\nST_Oligodendrocyte.precursor.cells\nST_Oligodendrocytes\nST_Peptidergic.neurons\nST_Pericytes\nST_Peripheral.sensory.neurofilament.neurons\nST_Peripheral.sensory.non.peptidergic.neurons\nST_Peripheral.sensory.peptidergic.neurons\nST_Perivascular.macrophages\nST_Satellite.glia\nST_Schwann.cells\nST_Spinal.cord.excitatory.neurons\nST_Spinal.cord.inhibitory.neurons\nST_Subcommissural.organ.hypendymal.cells\nST_Subventricular.zone.radial.glia.like.cells\nST_Sympathetic.cholinergic.neurons\nST_Sympathetic.noradrenergic.neurons\nST_Telencephalon.inhibitory.interneurons\nST_Telencephalon.projecting.excitatory.neurons\nST_Telencephalon.projecting.inhibitory.neurons.MSN1\nST_Telencephalon.projecting.inhibitory.neurons.MSN2\nST_Telencephalon.projecting.inhibitory.neurons.MSN3\nST_Telencephalon.projecting.inhibitory.neurons.MSN4\nST_Telencephalon.projecting.inhibitory.neurons.MSN5\nST_Telencephalon.projecting.inhibitory.neurons.MSN6\nST_Vascular.and.leptomeningeal.cells\nST_Vascular.endothelial.cells\nST_Vascular.smooth.muscle.cells\nST_nCount_SCT\nST_nFeature_SCT\nST_Astro_0\nST_Oligo_1\nST_MSN.D2.PenkPos_2\nST_MSN.D1.TacNeg_3\nST_Oligo_4\nST_MSN.D2.PenkNeg_5\nST_MSN.D1.TacPosB_6\nST_OPC_7\nST_Mi.MiR.Ma_8\nST_MSN.D1.TacPosA_9\nST_Astro_10\nST_Astro_11\nST_Inhib_MSN_12\nST_Inhib_13\nST_unk_14\nST_unk_15\nST_unk_16\nST_Astro_17\nST_MSN.D2_C_18\nST_unk_19\nST_OPC_20\nST_Oligo_21\nST_unk_22\nST_barcode\nST_library\nST_n_genes\nSM_i\nST_i\n</code>\n</pre> <pre><code>sc.pl.umap(\n        mdata,\n        color=[\"ST_RegionLoupe\", \"mz_674.2805\", \"GFAP\", \"TF\", \"NCDN\", \"SCG2\"],\n        # Setting a smaller point size to get prevent overlap\n        #size=5,\n)    \n</code></pre>"},{"location":"tutorial/run_SCrOFit_SMA/","title":"Run SMA data with SCrOFit","text":"<p>This notebook demosntrate how to use SCrOFit to run SMA data.</p> <pre><code>%autoreload\n\nimport anndata as ad\nimport os\nimport pandas as pd\n\nimport sys\nsys.path.append('../../')\n\nfrom scrofit.scrofit import SCrOFit\n\ndf = pd.read_csv('../../../data/MSA_data/corHstr_onlyCdSpots.csv', index_col=0)\nSMA_cor_df = df[(df['FDR'] &amp;lt; 0.05) &amp;amp; (df['rho'].abs() &amp;gt; 0.2)]\n\n\ndef run_align(in_dir, sample):\n\n    st_adata = ad.read_h5ad(f'{in_dir}/{sample}_st_raw.adata')\n    sm_adata = ad.read_h5ad(f'{in_dir}/{sample}_sm_raw.adata')\n    adata_dict = {'ST': st_adata, 'SM': sm_adata}\n\n    out_dir = os.path.join(in_dir, 'scrofit_out')\n\n    obj = SCrOFit(adata_dict=adata_dict, out_dir=out_dir, sample=sample)\n\n    obj.align_slides()\n\n    print('---start mapping---')\n    obj.mapping(mapping_method='MCMF', ccs_type='spatial_rir',\n                alpha=1, beta=1, n_neighbors=3,\n                n_thread=6, n_batch=250,\n                verbose=False)  \n\n    obj.check_slides()\n\n    headers = ['RegionLoupe', 'MSN.D2.PenkPos_2', 'MSN.D1.TacNeg_3', 'MSN.D2.PenkNeg_5',\n               'MSN.D1.TacPosB_6', 'MSN.D1.TacPosA_9', 'MSN.D2_C_18'] + SMA_cor_df['gene'].tolist()\n    obj.transfer_anno(headers)\n\n    for key, adata in adata_dict.items():\n        fn = '{}/{}_{}_pp.adata'.format(in_dir, sample, key.lower())\n        adata.write_h5ad(fn)\n\n    return obj, adata_dict\n\nobj_dict = {}\nfor sample in ['V11T17-102']:\n    for block in ['A1', 'B1', 'C1', 'D1']:\n        print(block)\n        in_dir = f'../../../data/MSA_data/{sample}'\n        obj, adata_dict = run_align(in_dir, sample + '_' + block)\n        obj_dict[block] = obj\n</code></pre> <pre><code>%autoreload\n\nimport anndata as ad\nimport os\nimport numpy as np\nfrom scrofit.mapping import init_mdata\n\ndef merge_celltype(st_adata):\n    cell_types = [\"Astro_0\",\"Oligo_1\",\"MSN.D2.PenkPos_2\",\"MSN.D1.TacNeg_3\",\"Oligo_4\",\"MSN.D2.PenkNeg_5\",\n    \"MSN.D1.TacPosB_6\",\"OPC_7\",\"Mi.MiR.Ma_8\",\"MSN.D1.TacPosA_9\",\"Astro_10\",\"Astro_11\",\"Inhib_MSN_12\",\n    \"Inhib_13\",\"unk_14\",\"unk_15\",\"unk_16\",\"Astro_17\",\"MSN.D2_C_18\",\"unk_19\",\"OPC_20\",\"Oligo_21\",\"unk_22\"]\n    X = st_adata.obs[cell_types].to_numpy()\n    st_adata.obs['Cell Type'] = np.array(cell_types)[X.argmax(axis=1)]\n    st_adata.obs['Cell Type'] = st_adata.obs['Cell Type'].apply(lambda x: '_'.join(x.split('_')[:-1]))\n    st_adata.obs['Cell Type'] = st_adata.obs['Cell Type'].apply(lambda x: np.nan if x == 'unk' else x)\n    mymap = {\n        'MSN.D2.PenkNeg': 'MSN',\n        'MSN.D1.TacPosB': 'MSN', \n        'MSN.D1.TacPosA': 'MSN', \n        'MSN.D2.PenkPos': 'MSN', \n        'MSN.D1.TacNeg': 'MSN',  \n        'MSN.D2_C': 'MSN', \n    }\n    st_adata.obs['Cell_Type']  =st_adata.obs['Cell Type'].apply(lambda x: mymap.get(x, x))\n\n\ndef replace_y_coord(in_dir, sample, block, i):\n    st_adata = ad.read_h5ad(f'{in_dir}/{sample}_{block}_st_pp.adata')\n    sm_adata = ad.read_h5ad(f'{in_dir}/{sample}_{block}_sm_pp.adata')\n\n    for key in  ['spatial_rir', 'spatial_rir_filtered', 'spatial_MCMF_map', 'spatial']:\n        if key in st_adata.obsm:\n            st_adata.obsm[key][:, 1] += 45000*i\n            print(sample, key, 'ST', st_adata.obsm[key][:, 1].min(), st_adata.obsm[key][:, 1].max())\n        if key in sm_adata.obsm:\n            if key == 'spatial':\n                sm_adata.obsm[key][:, 1] += 70*i\n            else:\n                sm_adata.obsm[key][:, 1] += 45000*i\n            print(sample, key, 'ST', sm_adata.obsm[key][:, 1].min(), sm_adata.obsm[key][:, 1].max())\n\n    return st_adata, sm_adata\n\nst_adata_list, sm_adata_list = [], []\nmdata_list = []\nfor sample in ['V11T17-102']:\n    image_list = []\n    for i, block in enumerate(['A1', 'B1', 'C1', 'D1']):\n        in_dir = f'../../../data/MSA_data/{sample}'\n        st_adata, sm_adata = replace_y_coord(in_dir, sample, block, i)\n        merge_celltype(st_adata)\n\n        st_adata_list.append(st_adata)\n        sm_adata_list.append(sm_adata)\n\n        image = st_adata.uns['spatial'][f'{sample}_{block}']['images']['hires']\n        scalefactors = st_adata.uns['spatial'][f'{sample}_{block}']['scalefactors']\n\n        image_list.append(image)\n\n        #for col in sm_adata.obs.columns:\n        #    if col.startswith('ST'):\n        #        del sm_adata.obs[col]\n        mdata = init_mdata(sm_adata, st_adata)  \n        mdata_list.append(mdata)\n\n\n    st_adata = ad.concat(st_adata_list)\n    print(st_adata_list[0].uns['spatial'][f'{sample}_A1']['scalefactors'])\n    print(st_adata_list[1].uns['spatial'][f'{sample}_B1']['scalefactors'])\n    print(st_adata_list[2].uns['spatial'][f'{sample}_C1']['scalefactors'])\n    print(st_adata_list[3].uns['spatial'][f'{sample}_D1']['scalefactors'])    \n    st_adata.uns['spatial'] = {sample:{\n        'images': {'hires': np.concatenate(image_list)},\n        'scalefactors': scalefactors\n        }}\n\n    sm_adata = ad.concat(sm_adata_list)\n    sm_adata.uns['spatial'] = {sample:{'images': {'hires': np.concatenate(image_list)}}}\n\n    mdata = ad.concat(mdata_list)\n\n\n    st_adata.write_h5ad(f'{in_dir}/{sample}_st_pp.adata')\n    sm_adata.write_h5ad(f'{in_dir}/{sample}_sm_pp.adata')\n</code></pre> <pre>\n<code>V11T17-102 spatial_rir ST 3267 41826\nV11T17-102 spatial_rir ST 3559.905021567236 40827.900430471855\nV11T17-102 spatial_rir_filtered ST 3267 41826\nV11T17-102 spatial_rir_filtered ST nan nan\nV11T17-102 spatial_MCMF_map ST nan nan\nV11T17-102 spatial ST 3267 41826\nV11T17-102 spatial ST 0 64\nV11T17-102 spatial_rir ST 47834 86785\nV11T17-102 spatial_rir ST 48144.84619771383 85815.9645796817\nV11T17-102 spatial_rir_filtered ST 47834 86785\nV11T17-102 spatial_rir_filtered ST nan nan\nV11T17-102 spatial_MCMF_map ST nan nan\nV11T17-102 spatial ST 47834 86785\nV11T17-102 spatial ST 70 134\nV11T17-102 spatial_rir ST 92762 131250\nV11T17-102 spatial_rir ST 92999.24074128651 130552.32918017515\nV11T17-102 spatial_rir_filtered ST 92762 131250\nV11T17-102 spatial_rir_filtered ST nan nan\nV11T17-102 spatial_MCMF_map ST nan nan\nV11T17-102 spatial ST 92762 131250\nV11T17-102 spatial ST 140 204\nV11T17-102 spatial_rir ST 137673 176669\nV11T17-102 spatial_rir ST 137570.2394988102 177668.60153934648\nV11T17-102 spatial_rir_filtered ST 137673 176669\nV11T17-102 spatial_rir_filtered ST nan nan\nV11T17-102 spatial_MCMF_map ST nan nan\nV11T17-102 spatial ST 137673 176669\nV11T17-102 spatial ST 210 275\n{'fiducial_diameter_fullres': np.float64(610.9539999999998), 'spot_diameter_fullres': np.float64(378.20962999999995), 'tissue_hires_scalef': np.float64(0.04111842), 'tissue_lowres_scalef': np.float64(0.012335527)}\n{'fiducial_diameter_fullres': np.float64(609.50275), 'spot_diameter_fullres': np.float64(377.31122), 'tissue_hires_scalef': np.float64(0.04111842), 'tissue_lowres_scalef': np.float64(0.012335527)}\n{'fiducial_diameter_fullres': np.float64(609.6982399999999), 'spot_diameter_fullres': np.float64(377.43224999999995), 'tissue_hires_scalef': np.float64(0.04111842), 'tissue_lowres_scalef': np.float64(0.012335527)}\n{'fiducial_diameter_fullres': np.float64(609.4973), 'spot_diameter_fullres': np.float64(377.30785999999995), 'tissue_hires_scalef': np.float64(0.04111842), 'tissue_lowres_scalef': np.float64(0.012335527)}\n</code>\n</pre> <pre>\n<code>/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/anndata/_core/aligned_df.py:68: ImplicitModificationWarning: Transforming to str index.\n/Users/chenlingxi/miniconda3/envs/dev/lib/python3.11/site-packages/anndata/_core/anndata.py:1756: UserWarning: Observation names are not unique. To make them unique, call `.obs_names_make_unique`.\n</code>\n</pre> <pre><code>mdata\n</code></pre> <pre>\n<code>AnnData object with n_obs \u00d7 n_vars = 15813 \u00d7 13934\n    obs: 'SM_index', 'SM_sample', 'SM_block', 'SM_n_genes', 'SM_ST_RegionLoupe', 'SM_ST_MSN.D2.PenkNeg_5', 'SM_ST_MSN.D1.TacNeg_3', 'SM_ST_MSN.D2_C_18', 'SM_ST_MSN.D1.TacPosB_6', 'SM_ST_MSN.D1.TacPosA_9', 'SM_ST_MSN.D2.PenkPos_2', 'SM_ST_ST_id', 'SM_LY6H', 'SM_THY1', 'SM_VSNL1', 'SM_PCDH11X', 'SM_MBP', 'SM_PLP1', 'SM_CHN1', 'SM_SYNPR', 'SM_NCDN', 'SM_MAP2', 'SM_GDA', 'SM_HPCAL4', 'SM_RTN1', 'SM_NNAT', 'SM_TSPAN7', 'SM_PEG10', 'SM_SCG2', 'SM_TF', 'SM_CRYM', 'SM_GFAP', 'SM_MT1G', 'ST_index', 'ST_in_tissue', 'ST_array_row', 'ST_array_col', 'ST_dopamine', 'ST_cell_type', 'ST_sample', 'ST_block', 'ST_orig.ident', 'ST_nCount_RNA', 'ST_nFeature_RNA', 'ST_Protocol', 'ST_Path.To.File', 'ST_File.Name', 'ST_Data.Type', 'ST_Glass.Type', 'ST_ArrayID', 'ST_Sample.ID', 'ST_Matrix', 'ST_Laser', 'ST_Laser.resolution', 'ST_Condition', 'ST_Brain.area', 'ST_Visium.Protocol', 'ST_id', 'ST_labels', 'ST_Prot.Short', 'ST_section_number', 'ST_type', 'ST_type.area', 'ST_lesion', 'ST_region', 'ST_RegionLoupe', 'ST_percent.mito', 'ST_percent.ribo', 'ST_Astrocytes', 'ST_Cerebellum.neurons', 'ST_Cholinergic.and.monoaminergic.neurons', 'ST_Cholinergic.and.monoaminergic.neurons.MBDOP1', 'ST_Cholinergic.and.monoaminergic.neurons.MBDOP2', 'ST_Choroid.epithelial.cells', 'ST_Dentate.gyrus.granule.neurons', 'ST_Dentate.gyrus.radial.glia.like.cells', 'ST_Di..and.mesencephalon.excitatory.neurons', 'ST_Di..and.mesencephalon.inhibitory.neurons', 'ST_Enteric.glia', 'ST_Enteric.neurons', 'ST_Ependymal.cells', 'ST_Glutamatergic.neuroblasts', 'ST_Hindbrain.neurons', 'ST_Microglia', 'ST_Non.glutamatergic.neuroblasts', 'ST_Olfactory.ensheathing.cells', 'ST_Olfactory.inhibitory.neurons', 'ST_Olfactory.inhibitory.neurons.OBDOP1', 'ST_Olfactory.inhibitory.neurons.OBDOP2', 'ST_Oligodendrocyte.precursor.cells', 'ST_Oligodendrocytes', 'ST_Peptidergic.neurons', 'ST_Pericytes', 'ST_Peripheral.sensory.neurofilament.neurons', 'ST_Peripheral.sensory.non.peptidergic.neurons', 'ST_Peripheral.sensory.peptidergic.neurons', 'ST_Perivascular.macrophages', 'ST_Satellite.glia', 'ST_Schwann.cells', 'ST_Spinal.cord.excitatory.neurons', 'ST_Spinal.cord.inhibitory.neurons', 'ST_Subcommissural.organ.hypendymal.cells', 'ST_Subventricular.zone.radial.glia.like.cells', 'ST_Sympathetic.cholinergic.neurons', 'ST_Sympathetic.noradrenergic.neurons', 'ST_Telencephalon.inhibitory.interneurons', 'ST_Telencephalon.projecting.excitatory.neurons', 'ST_Telencephalon.projecting.inhibitory.neurons.MSN1', 'ST_Telencephalon.projecting.inhibitory.neurons.MSN2', 'ST_Telencephalon.projecting.inhibitory.neurons.MSN3', 'ST_Telencephalon.projecting.inhibitory.neurons.MSN4', 'ST_Telencephalon.projecting.inhibitory.neurons.MSN5', 'ST_Telencephalon.projecting.inhibitory.neurons.MSN6', 'ST_Vascular.and.leptomeningeal.cells', 'ST_Vascular.endothelial.cells', 'ST_Vascular.smooth.muscle.cells', 'ST_nCount_SCT', 'ST_nFeature_SCT', 'ST_Astro_0', 'ST_Oligo_1', 'ST_MSN.D2.PenkPos_2', 'ST_MSN.D1.TacNeg_3', 'ST_Oligo_4', 'ST_MSN.D2.PenkNeg_5', 'ST_MSN.D1.TacPosB_6', 'ST_OPC_7', 'ST_Mi.MiR.Ma_8', 'ST_MSN.D1.TacPosA_9', 'ST_Astro_10', 'ST_Astro_11', 'ST_Inhib_MSN_12', 'ST_Inhib_13', 'ST_unk_14', 'ST_unk_15', 'ST_unk_16', 'ST_Astro_17', 'ST_MSN.D2_C_18', 'ST_unk_19', 'ST_OPC_20', 'ST_Oligo_21', 'ST_unk_22', 'ST_barcode', 'ST_library', 'ST_n_genes', 'SM_i', 'ST_i'\n    obsm: 'SM_XY_spatial_euclidean_dist', 'SM_mappingflow_MCMF', 'SM_spatial', 'SM_spatial_MCMF_map', 'SM_spatial_normalized', 'SM_spatial_rir', 'SM_spatial_rir_filtered', 'ST_spatial', 'ST_spatial_normalized', 'ST_spatial_rir', 'ST_spatial_rir_filtered'\n    layers: 'log1p', 'raw'</code>\n</pre> <pre><code>%autoreload\nfrom scrofit.embedding import embedding\n\nembedding(mdata)\nmdata.write_h5ad(f'{in_dir}/{sample}_m_pp.adata')\n</code></pre>"}]}